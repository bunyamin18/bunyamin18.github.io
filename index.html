<!DOCTYPE html>
<html lang="tr">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Liste Oluştur QR Kod Paylaş</title>
    <link href="https://cdnjs.cloudflare.com/ajax/libs/tailwindcss/2.2.19/tailwind.min.css" rel="stylesheet">
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.0.0-beta3/css/all.min.css">
    <script src="https://cdnjs.cloudflare.com/ajax/libs/qrcodejs/1.0.0/qrcode.min.js"></script>
    <script src="https://unpkg.com/html5-qrcode@2.3.8/html5-qrcode.min.js"></script>
    <style>
        /* Ana renk tanımlamaları */
        .bg-primary {
            background-color: #4f46e5;
        }
        .text-primary {
            color: #4f46e5;
        }
        .border-primary {
            border-color: #4f46e5;
        }
        .hover-bg-primary:hover {
            background-color: #4338ca;
        }
        /* Genel geçişler */
        .transition-all {
            transition: all 0.3s ease;
        }
        /* Gizli öğeler için */
        .hidden {
            display: none;
        }
        /* Maksimum yükseklik sınırlaması */
        .max-h-96 {
            max-height: 24rem;
        }
        /* QR kod tarayıcı video boyutu */
        #qr-video {
            width: 100%;
            max-width: 400px; /* Maksimum genişlik */
            height: auto;
            border-radius: 0.5rem;
        }

        /* QR Kod Tablosu İçin Özel Stiller */
        /* QRCode.js varsayılan olarak bir HTML tablosu oluşturur. Bu stiller, tablonun görünür olmasını sağlar. */
        #qrcode-container table,
        #modal-qrcode-container table {
            border-collapse: collapse; /* Hücreler arasındaki boşluğu kaldırır */
            padding: 0;
            margin: 0;
        }
        #qrcode-container table td,
        #modal-qrcode-container table td {
            width: 2px; /* QR modülleri için küçük hücre boyutu */
            height: 2px;
            padding: 0; /* İç boşluğu kaldırır */
            margin: 0;
        }
        /* Koyu modüller için renk */
        #qrcode-container table td.qrcode-dark,
        #modal-qrcode-container table td.qrcode-dark {
            background-color: #4f46e5; /* Ana renk */
        }
        /* Açık modüller için renk */
        #qrcode-container table td.qrcode-light,
        #modal-qrcode-container table td.qrcode-light {
            background-color: #ffffff; /* Beyaz */
        }
    </style>
</head>
<body class="bg-gray-50 min-h-screen font-sans">
    <script src="https://www.gstatic.com/firebasejs/9.6.1/firebase-app-compat.js"></script>
    <script src="https://www.gstatic.com/firebasejs/9.6.1/firebase-auth-compat.js"></script>
    <script src="https://www.gstatic.com/firebasejs/9.6.1/firebase-firestore-compat.js"></script>
    <script src="https://www.gstatic.com/firebasejs/9.6.1/firebase-storage-compat.js"></script>

    <header class="bg-white shadow-md">
        <div class="container mx-auto px-4 py-3 flex justify-between items-center">
            <div class="flex items-center space-x-2">
                <i class="fas fa-qrcode text-3xl text-primary"></i>
                <h1 class="text-2xl font-bold text-gray-800">QR Liste</h1>
            </div>
            <nav id="main-nav" class="hidden md:flex space-x-6">
                <a href="#" class="text-gray-600 hover:text-primary transition-all" onclick="showPage('home')">Ana Sayfa</a>
                <a href="#" class="text-gray-600 hover:text-primary transition-all" onclick="showPage('guide')">Kullanım Kılavuzu</a>
                <a href="#" class="text-gray-600 hover:text-primary transition-all" onclick="showPage('contact')">İletişim</a>
                <a href="#" class="text-gray-600 hover:text-primary transition-all auth-hide" onclick="showPage('login')">Giriş Yap</a>
                <a href="#" class="text-gray-600 hover:text-primary transition-all auth-hide" onclick="showPage('register')">Kayıt Ol</a>
                <a href="#" class="text-gray-600 hover:text-primary transition-all auth-show hidden" onclick="showPage('dashboard')">Listelerim</a>
                <a href="#" class="text-gray-600 hover:text-primary transition-all auth-show hidden" onclick="logout()">Çıkış Yap</a>
            </nav>
            <button class="md:hidden text-gray-600" id="mobile-menu-button">
                <i class="fas fa-bars text-2xl"></i>
            </button>
        </div>
        <div class="md:hidden hidden" id="mobile-menu">
            <div class="px-2 pt-2 pb-3 space-y-1 sm:px-3 bg-white shadow-md">
                <a href="#" class="block px-3 py-2 text-gray-600 hover:text-primary transition-all" onclick="showPage('home')">Ana Sayfa</a>
                <a href="#" class="block px-3 py-2 text-gray-600 hover:text-primary transition-all" onclick="showPage('guide')">Kullanım Kılavuzu</a>
                <a href="#" class="block px-3 py-2 text-gray-600 hover:text-primary transition-all" onclick="showPage('contact')">İletişim</a>
                <a href="#" class="block px-3 py-2 text-gray-600 hover:text-primary transition-all auth-hide" onclick="showPage('login')">Giriş Yap</a>
                <a href="#" class="block px-3 py-2 text-gray-600 hover:text-primary transition-all auth-hide" onclick="showPage('register')">Kayıt Ol</a>
                <a href="#" class="block px-3 py-2 text-gray-600 hover:text-primary transition-all auth-show hidden" onclick="showPage('dashboard')">Listelerim</a>
                <a href="#" class="block px-3 py-2 text-gray-600 hover:text-primary transition-all auth-show hidden" onclick="logout()">Çıkış Yap</a>
            </div>
        </div>
    </header>

    <main class="container mx-auto p-4 mt-8">
        <div id="home" class="page">
            <div class="text-center mb-16">
                <h2 class="text-4xl font-bold text-gray-800 mb-4">Liste Oluştur, QR Kod ile Paylaş</h2>
                <p class="text-xl text-gray-600 max-w-2xl mx-auto">
                    İhtiyaç listelerinizi kolayca oluşturun, QR kod ile paylaşın ve güncelleyin.
                </p>
                <div class="mt-10">
                    <button onclick="showPage('login')" class="bg-primary text-white px-8 py-3 rounded-lg shadow-lg hover-bg-primary transition-all auth-hide">
                        Hemen Başla
                    </button>
                    <button onclick="showPage('createList')" class="bg-primary text-white px-8 py-3 rounded-lg shadow-lg hover-bg-primary transition-all auth-show hidden">
                        Liste Oluştur
                    </button>
                </div>
            </div>
            
            <div class="grid md:grid-cols-3 gap-8 mt-12">
                <div class="bg-white p-6 rounded-xl shadow-md">
                    <div class="text-primary text-4xl mb-4">
                        <i class="fas fa-pencil-alt"></i>
                    </div>
                    <h3 class="text-xl font-bold mb-2">Kolay Liste Oluşturma</h3>
                    <p class="text-gray-600">
                        İhtiyaçlarınızı, miktarlarını ve görselleri ekleyerek detaylı listeler oluşturun.
                    </p>
                </div>
                <div class="bg-white p-6 rounded-xl shadow-md">
                    <div class="text-primary text-4xl mb-4">
                        <i class="fas fa-qrcode"></i>
                    </div>
                    <h3 class="text-xl font-bold mb-2">QR Kod Paylaşımı</h3>
                    <p class="text-gray-600">
                        Oluşturduğunuz listeleri QR kod aracılığıyla anında paylaşabilirsiniz.
                    </p>
                </div>
                <div class="bg-white p-6 rounded-xl shadow-md">
                    <div class="text-primary text-4xl mb-4">
                        <i class="fas fa-edit"></i>
                    </div>
                    <h3 class="text-xl font-bold mb-2">Kolay Düzenleme</h3>
                    <p class="text-gray-600">
                        QR kodu okutarak listenizi istediğiniz zaman düzenleyebilirsiniz.
                    </p>
                </div>
            </div>
        </div>

        <div id="login" class="page hidden">
            <div class="max-w-md mx-auto bg-white p-8 rounded-xl shadow-md">
                <h2 class="text-2xl font-bold text-gray-800 mb-6 text-center">Giriş Yap</h2>
                <div id="login-error" class="bg-red-100 text-red-600 p-3 rounded mb-4 hidden"></div>
                <form id="login-form">
                    <div class="mb-4">
                        <label for="login-email" class="block text-gray-700 mb-2">E-posta Adresi</label>
                        <input type="email" id="login-email" class="w-full px-4 py-2 border rounded-lg focus:outline-none focus:ring-2 focus:ring-primary" required>
                    </div>
                    <div class="mb-6">
                        <label for="login-password" class="block text-gray-700 mb-2">Şifre</label>
                        <input type="password" id="login-password" class="w-full px-4 py-2 border rounded-lg focus:outline-none focus:ring-2 focus:ring-primary" required>
                    </div>
                    <button type="submit" class="w-full bg-primary text-white py-2 rounded-lg hover-bg-primary transition-all">
                        Giriş Yap
                    </button>
                </form>
                <div class="mt-4 text-center">
                    <p class="text-gray-600">
                        Hesabınız yok mu? 
                        <a href="#" class="text-primary hover:underline" onclick="showPage('register')">Kayıt Ol</a>
                    </p>
                </div>
            </div>
        </div>

        <div id="register" class="page hidden">
            <div class="max-w-md mx-auto bg-white p-8 rounded-xl shadow-md">
                <h2 class="text-2xl font-bold text-gray-800 mb-6 text-center">Hesap Oluştur</h2>
                <div id="register-error" class="bg-red-100 text-red-600 p-3 rounded mb-4 hidden"></div>
                <form id="register-form">
                    <div class="mb-4">
                        <label for="register-name" class="block text-gray-700 mb-2">Ad Soyad</label>
                        <input type="text" id="register-name" class="w-full px-4 py-2 border rounded-lg focus:outline-none focus:ring-2 focus:ring-primary" required>
                    </div>
                    <div class="mb-4">
                        <label for="register-email" class="block text-gray-700 mb-2">E-posta Adresi</label>
                        <input type="email" id="register-email" class="w-full px-4 py-2 border rounded-lg focus:outline-none focus:ring-2 focus:ring-primary" required>
                    </div>
                    <div class="mb-6">
                        <label for="register-password" class="block text-gray-700 mb-2">Şifre</label>
                        <input type="password" id="register-password" class="w-full px-4 py-2 border rounded-lg focus:outline-none focus:ring-2 focus:ring-primary" required>
                    </div>
                    <button type="submit" class="w-full bg-primary text-white py-2 rounded-lg hover-bg-primary transition-all">
                        Kayıt Ol
                    </button>
                </form>
                <div class="mt-4 text-center">
                    <p class="text-gray-600">
                        Zaten hesabınız var mı? 
                        <a href="#" class="text-primary hover:underline" onclick="showPage('login')">Giriş Yap</a>
                    </p>
                </div>
            </div>
        </div>

        <div id="dashboard" class="page hidden">
            <div class="mb-6 flex justify-between items-center">
                <h2 class="text-3xl font-bold text-gray-800">Listelerim</h2>
                <button onclick="showPage('createList')" class="bg-primary text-white px-4 py-2 rounded-lg shadow hover-bg-primary transition-all flex items-center">
                    <i class="fas fa-plus mr-2"></i> Yeni Liste Oluştur
                </button>
            </div>
            
            <div id="qr-list-counter" class="mb-4 text-gray-600"></div>
            
            <div id="user-lists" class="grid md:grid-cols-2 lg:grid-cols-3 gap-6">
                <div class="text-center text-gray-500 col-span-full py-10" id="no-lists-message">
                    <i class="fas fa-clipboard-list text-5xl mb-4"></i>
                    <p class="text-xl">Henüz liste oluşturmadınız.</p>
                </div>
            </div>
        </div>

        <div id="createList" class="page hidden">
            <div class="max-w-4xl mx-auto">
                <div class="mb-6">
                    <h2 class="text-3xl font-bold text-gray-800">Yeni Liste Oluştur</h2>
                    <p class="text-gray-600 mt-2">Liste adını belirleyin ve öğeler ekleyin.</p>
                </div>
                
                <div class="bg-white p-6 rounded-xl shadow-md mb-8">
                    <h3 class="text-xl font-bold text-gray-800 mb-4">Liste Adı</h3>
                    <div class="mb-4">
                        <label for="list-name" class="block text-gray-700 mb-2">Liste Adı</label>
                        <input type="text" id="list-name" class="w-full px-4 py-2 border rounded-lg focus:outline-none focus:ring-2 focus:ring-primary" placeholder="Alışveriş Listesi" required>
                    </div>
                    
                    <h3 class="text-xl font-bold text-gray-800 mb-4">Yeni Öğe Ekle</h3>
                    
                    <div class="grid md:grid-cols-3 gap-4 mb-4">
                        <div>
                            <label for="item-name" class="block text-gray-700 mb-2">Öğe İsmi</label>
                            <input type="text" id="item-name" class="w-full px-4 py-2 border rounded-lg focus:outline-none focus:ring-2 focus:ring-primary" placeholder="Elma">
                        </div>
                        <div>
                            <label for="item-quantity" class="block text-gray-700 mb-2">Öğe Miktarı</label>
                            <input type="text" id="item-quantity" class="w-full px-4 py-2 border rounded-lg focus:outline-none focus:ring-2 focus:ring-primary" placeholder="2 kg">
                        </div>
                        <div>
                            <label for="item-image" class="block text-gray-700 mb-2">Resim (İsteğe Bağlı)</label>
                            <input type="file" id="item-image" accept="image/*" class="w-full px-4 py-1.5 border rounded-lg focus:outline-none focus:ring-2 focus:ring-primary">
                            <p id="imageError" class="text-red-500 text-xs mt-1"></p>
                        </div>
                    </div>
                    
                    <button id="add-item" class="bg-primary text-white px-4 py-2 rounded-lg shadow hover-bg-primary transition-all">
                        <i class="fas fa-plus mr-2"></i> Öğe Ekle
                    </button>
                </div>
                
                <div class="bg-white p-6 rounded-xl shadow-md mb-8">
                    <h3 class="text-xl font-bold text-gray-800 mb-4">Liste Öğeleri</h3>
                    
                    <div id="item-list" class="max-h-96 overflow-y-auto">
                        </div>
                    <div id="empty-list-message" class="text-center py-8 text-gray-500">
                        <i class="fas fa-clipboard text-4xl mb-3"></i>
                        <p>Henüz öğe eklemediniz.</p>
                    </div>
                </div>
                
                <div class="flex justify-end">
                    <button id="save-list" class="bg-primary text-white px-6 py-3 rounded-lg shadow-lg hover-bg-primary transition-all">
                        <i class="fas fa-save mr-2"></i> Kaydet ve QR Kod Oluştur
                    </button>
                </div>
            </div>
        </div>

        <div id="viewList" class="page hidden">
            <div class="max-w-4xl mx-auto">
                <div class="mb-6 flex items-center">
                    <button onclick="showPage('dashboard')" class="text-gray-600 hover:text-primary mr-4">
                        <i class="fas fa-arrow-left text-lg"></i>
                    </button>
                    <h2 class="text-3xl font-bold text-gray-800" id="view-list-name">Liste Detayları</h2>
                </div>
                
                <div class="grid md:grid-cols-3 gap-6">
                    <div class="md:col-span-2">
                        <div class="bg-white p-6 rounded-xl shadow-md mb-6">
                            <h3 class="text-xl font-bold text-gray-800 mb-4">Liste Öğeleri</h3>
                            
                            <div id="view-item-list" class="max-h-96 overflow-y-auto">
                                </div>
                        </div>
                        
                        <div class="flex justify-end">
                            <button id="edit-list" class="bg-primary text-white px-6 py-3 rounded-lg shadow-lg hover-bg-primary transition-all">
                                <i class="fas fa-edit mr-2"></i> Listeyi Düzenle
                            </button>
                        </div>
                    </div>
                    
                    <div>
                        <div class="bg-white p-6 rounded-xl shadow-md">
                            <h3 class="text-xl font-bold text-gray-800 mb-4">QR Kod</h3>
                            <div id="qrcode-container" class="flex justify-center mb-4"></div>
                            <button id="download-qr" class="w-full bg-gray-200 text-gray-800 px-4 py-2 rounded-lg hover:bg-gray-300 transition-all flex items-center justify-center">
                                <i class="fas fa-download mr-2"></i> QR Kodu İndir
                            </button>
                        </div>
                    </div>
                </div>
            </div>
        </div>

        <div id="editList" class="page hidden">
            <div class="max-w-4xl mx-auto">
                <div class="mb-6">
                    <h2 class="text-3xl font-bold text-gray-800">Listeyi Düzenle</h2>
                    <p class="text-gray-600 mt-2" id="edit-list-id"></p>
                </div>
                
                <div class="bg-white p-6 rounded-xl shadow-md mb-8">
                    <div class="mb-6">
                        <label for="edit-list-name" class="block text-gray-700 mb-2 font-medium">Liste Adı</label>
                        <input type="text" id="edit-list-name" class="w-full px-4 py-2 border rounded-lg focus:outline-none focus:ring-2 focus:ring-primary" required>
                    </div>
                </div>
                
                <div class="bg-white p-6 rounded-xl shadow-md mb-8">
                    <h3 class="text-xl font-bold text-gray-800 mb-4">Yeni Öğe Ekle</h3>
                    
                    <div class="grid md:grid-cols-3 gap-4 mb-4">
                        <div>
                            <label for="edit-item-name" class="block text-gray-700 mb-2">Öğe İsmi</label>
                            <input type="text" id="edit-item-name" class="w-full px-4 py-2 border rounded-lg focus:outline-none focus:ring-2 focus:ring-primary" placeholder="Elma">
                        </div>
                        <div>
                            <label for="edit-item-quantity" class="block text-gray-700 mb-2">Öğe Miktarı</label>
                            <input type="text" id="edit-item-quantity" class="w-full px-4 py-2 border rounded-lg focus:outline-none focus:ring-2 focus:ring-primary" placeholder="2 kg">
                        </div>
                        <div>
                            <label for="edit-item-image" class="block text-gray-700 mb-2">Resim (İsteğe Bağlı)</label>
                            <input type="file" id="edit-item-image" accept="image/*" class="w-full px-4 py-1.5 border rounded-lg focus:outline-none focus:ring-2 focus:ring-primary">
                            <p id="editImageError" class="text-red-500 text-xs mt-1"></p>
                        </div>
                    </div>
                    
                    <button id="edit-add-item" class="bg-primary text-white px-4 py-2 rounded-lg shadow hover-bg-primary transition-all">
                        <i class="fas fa-plus mr-2"></i> Öğe Ekle
                    </button>
                </div>
                
                <div class="bg-white p-6 rounded-xl shadow-md mb-8">
                    <h3 class="text-xl font-bold text-gray-800 mb-4">Liste Öğeleri</h3>
                    
                    <div id="edit-item-list" class="max-h-96 overflow-y-auto">
                        </div>
                </div>
                
                <div class="flex justify-between">
                    <button onclick="cancelEdit()" class="bg-gray-200 text-gray-800 px-6 py-3 rounded-lg shadow-lg hover:bg-gray-300 transition-all">
                        <i class="fas fa-times mr-2"></i> İptal
                    </button>
                    <button id="update-list" class="bg-primary text-white px-6 py-3 rounded-lg shadow-lg hover-bg-primary transition-all">
                        <i class="fas fa-save mr-2"></i> Değişiklikleri Kaydet
                    </button>
                </div>
            </div>
        </div>

        <div id="publicList" class="page hidden">
            <div class="max-w-4xl mx-auto">
                <div class="mb-6">
                    <h2 class="text-3xl font-bold text-gray-800" id="public-list-name">Liste</h2>
                    <p class="text-gray-600 mt-2" id="public-list-id"></p>
                </div>
                
                <div class="bg-white p-6 rounded-xl shadow-md mb-8">
                    <h3 class="text-xl font-bold text-gray-800 mb-4">Liste Öğeleri</h3>
                    
                    <div id="public-item-list" class="max-h-96 overflow-y-auto">
                        </div>
                </div>
                
                <div class="flex justify-end">
                    <button id="edit-public-list" class="bg-primary text-white px-6 py-3 rounded-lg shadow-lg hover-bg-primary transition-all">
                        <i class="fas fa-edit mr-2"></i> Listeyi Düzenle
                    </button>
                </div>
            </div>
        </div>

        <div id="editPublicList" class="page hidden">
            <div class="max-w-4xl mx-auto">
                <div class="mb-6">
                    <h2 class="text-3xl font-bold text-gray-800">Listeyi Düzenle</h2>
                    <p class="text-gray-600 mt-2" id="edit-public-list-id"></p>
                </div>
                
                <div class="bg-white p-6 rounded-xl shadow-md mb-8">
                    <div class="mb-6">
                        <label for="edit-public-list-name" class="block text-gray-700 mb-2 font-medium">Liste Adı</label>
                        <input type="text" id="edit-public-list-name" class="w-full px-4 py-2 border rounded-lg focus:outline-none focus:ring-2 focus:ring-primary" required>
                    </div>
                </div>
                
                <div class="bg-white p-6 rounded-xl shadow-md mb-8">
                    <h3 class="text-xl font-bold text-gray-800 mb-4">Yeni Öğe Ekle</h3>
                    
                    <div class="grid md:grid-cols-3 gap-4 mb-4">
                        <div>
                            <label for="edit-public-item-name" class="block text-gray-700 mb-2">Öğe İsmi</label>
                            <input type="text" id="edit-public-item-name" class="w-full px-4 py-2 border rounded-lg focus:outline-none focus:ring-2 focus:ring-primary" placeholder="Elma">
                        </div>
                        <div>
                            <label for="edit-public-item-quantity" class="block text-gray-700 mb-2">Öğe Miktarı</label>
                            <input type="text" id="edit-public-item-quantity" class="w-full px-4 py-2 border rounded-lg focus:outline-none focus:ring-2 focus:ring-primary" placeholder="2 kg">
                        </div>
                        <div>
                            <label for="edit-public-item-image" class="block text-gray-700 mb-2">Resim (İsteğe Bağlı)</label>
                            <input type="file" id="edit-public-item-image" accept="image/*" class="w-full px-4 py-1.5 border rounded-lg focus:outline-none focus:ring-2 focus:ring-primary">
                            <p id="editPublicImageError" class="text-red-500 text-xs mt-1"></p>
                        </div>
                    </div>
                    
                    <button id="edit-public-add-item" class="bg-primary text-white px-4 py-2 rounded-lg shadow hover-bg-primary transition-all">
                        <i class="fas fa-plus mr-2"></i> Öğe Ekle
                    </button>
                </div>
                
                <div class="bg-white p-6 rounded-xl shadow-md mb-8">
                    <h3 class="text-xl font-bold text-gray-800 mb-4">Liste Öğeleri</h3>
                    
                    <div id="edit-public-item-list" class="max-h-96 overflow-y-auto">
                        </div>
                </div>
                
                <div class="flex justify-between">
                    <button onclick="cancelPublicEdit()" class="bg-gray-200 text-gray-800 px-6 py-3 rounded-lg shadow-lg hover:bg-gray-300 transition-all">
                        <i class="fas fa-times mr-2"></i> İptal
                    </button>
                    <button id="update-public-list" class="bg-primary text-white px-6 py-3 rounded-lg shadow-lg hover-bg-primary transition-all">
                        <i class="fas fa-save mr-2"></i> Değişiklikleri Kaydet
                    </button>
                </div>
            </div>
        </div>

        <div id="qrScanner" class="page hidden">
            <div class="max-w-md mx-auto bg-white p-8 rounded-xl shadow-md">
                <h2 class="text-2xl font-bold text-gray-800 mb-6 text-center">QR Kod Tara</h2>
                <div class="text-center mb-4">
                    <input type="text" id="list-id-input" class="w-full px-4 py-2 border rounded-lg focus:outline-none focus:ring-2 focus:ring-primary" placeholder="Liste ID girin">
                </div>
                <button id="scan-qr-button" class="w-full bg-primary text-white py-2 rounded-lg hover-bg-primary transition-all mb-4">
                    <i class="fas fa-qrcode mr-2"></i> QR Kod Tara
                </button>
                <div id="qr-scanner-container" class="hidden mb-4 flex justify-center">
                    <video id="qr-video" class="w-full rounded-lg"></video>
                </div>
                <button id="view-list-button" class="w-full bg-primary text-white py-2 rounded-lg hover-bg-primary transition-all">
                    <i class="fas fa-eye mr-2"></i> Listeyi Görüntüle
                </button>
            </div>
        </div>

        <div id="guide" class="page hidden">
            <div class="max-w-3xl mx-auto">
                <h2 class="text-3xl font-bold text-gray-800 mb-6">Kullanım Kılavuzu</h2>
                
                <div class="bg-white p-6 rounded-xl shadow-md mb-8">
                    <h3 class="text-xl font-bold text-gray-800 mb-4">Hesap Oluşturma ve Giriş</h3>
                    <ol class="list-decimal pl-5 space-y-3 text-gray-700">
                        <li>Sağ üst köşedeki "Kayıt Ol" butonuna tıklayın.</li>
                        <li>Ad, e-posta ve şifre bilgilerinizi girin.</li>
                        <li>Hesabınızı oluşturduktan sonra, e-posta ve şifrenizle giriş yapabilirsiniz.</li>
                        <li>Her hesap en fazla 4 adet liste oluşturabilir.</li>
                    </ol>
                </div>
                
                <div class="bg-white p-6 rounded-xl shadow-md mb-8">
                    <h3 class="text-xl font-bold text-gray-800 mb-4">Liste Oluşturma</h3>
                    <ol class="list-decimal pl-5 space-y-3 text-gray-700">
                        <li>"Liste Oluştur" butonuna tıklayın.</li>
                        <li>Listenize bir isim verin.</li>
                        <li>Öğe ekleme formunda öğe adı, miktarı ve isterseniz bir resim ekleyin.</li>
                        <li>"Öğe Ekle" butonuna tıklayarak listeye ekleyin.</li>
                        <li>Tüm öğeleri ekledikten sonra "Kaydet ve QR Kod Oluştur" butonuna tıklayın.</li>
                    </ol>
                </div>
                
                <div class="bg-white p-6 rounded-xl shadow-md mb-8">
                    <h3 class="text-xl font-bold text-gray-800 mb-4">QR Kod Paylaşımı</h3>
                    <ol class="list-decimal pl-5 space-y-3 text-gray-700">
                        <li>Liste oluşturulduktan sonra otomatik olarak bir QR kod oluşturulacaktır.</li>
                        <li>"QR Kodu İndir" butonuna tıklayarak kodu kaydedebilirsiniz.</li>
                        <li>QR kodu başkalarıyla paylaşabilirsiniz.</li>
                        <li>QR kodu taratarak listeye erişebilir ve gerekirse düzenleyebilirsiniz.</li>
                    </ol>
                </div>
                
                <div class="bg-white p-6 rounded-xl shadow-md">
                    <h3 class="text-xl font-bold text-gray-800 mb-4">Liste Düzenleme</h3>
                    <ol class="list-decimal pl-5 space-y-3 text-gray-700">
                        <li>Listenizi görüntülerken "Listeyi Düzenle" butonuna tıklayın.</li>
                        <li>Liste adını veya öğeleri değiştirebilir, yeni öğeler ekleyebilir veya mevcut öğeleri silebilirsiniz.</li>
                        <li>Değişiklikleri tamamladıktan sonra "Değişiklikleri Kaydet" butonuna tıklayın.</li>
                        <li>Değişiklikler aynı QR kod üzerinden erişilebilir olacaktır.</li>
                    </ol>
                </div>
            </div>
        </div>

        <div id="contact" class="page hidden">
            <div class="max-w-3xl mx-auto">
                <h2 class="text-3xl font-bold text-gray-800 mb-6">İletişim</h2>
                
                <div class="bg-white p-6 rounded-xl shadow-md mb-8">
                    <div class="flex items-start mb-6">
                        <div class="text-primary text-2xl mr-4">
                            <i class="fas fa-envelope"></i>
                        </div>
                        <div>
                            <h3 class="text-xl font-bold text-gray-800 mb-1">E-posta</h3>
                            <p class="text-gray-700">ebunyamin0@gmail.com</p>
                        </div>
                    </div>
                    
                  
            </div>
        </div>
    </main>

    <footer class="bg-gray-800 text-white py-10 mt-16">
        <div class="container mx-auto px-4">
            <div class="grid md:grid-cols-3 gap-8">
                <div>
                    <div class="flex items-center space-x-2 mb-4">
                        <i class="fas fa-qrcode text-2xl text-white"></i>
                        <h3 class="text-xl font-bold">QR Liste</h3>
                    </div>
                    <p class="text-gray-400">
                        İhtiyaçlarınızı organize etmenin en kolay yolu. Liste oluşturun, QR kod ile paylaşın, düzenleyin.
                    </p>
                </div>
                
                <div>
                    <h3 class="text-lg font-bold mb-4">Hızlı Bağlantılar</h3>
                    <ul class="space-y-2 text-gray-400">
                        <li><a href="#" class="hover:text-white transition-all" onclick="showPage('home')">Ana Sayfa</a></li>
                        <li><a href="#" class="hover:text-white transition-all" onclick="showPage('guide')">Kullanım Kılavuzu</a></li>
                        <li><a href="#" class="hover:text-white transition-all" onclick="showPage('contact')">İletişim</a></li>
                        <li><a href="#" class="hover:text-white transition-all auth-hide" onclick="showPage('login')">Giriş Yap</a></li>
                        <li><a href="#" class="hover:text-white transition-all auth-hide" onclick="showPage('register')">Kayıt Ol</a></li>
                    </ul>
                </div>
                
                <div>
                    <h3 class="text-lg font-bold mb-4">İletişim</h3>
                    <ul class="space-y-2 text-gray-400">
                        <li class="flex items-start">
                            <i class="fas fa-envelope mt-1 mr-2"></i>
                            <span>ebunyamin0@gmail.com</span>
                        </li>
                    </ul>
                </div>
            </div>
            
            <div class="border-t border-gray-700 mt-8 pt-8 text-center text-gray-400">
                <p>&copy; 2025 Bünyamin Ekmekcioğlu</p>
            </div>
        </div>
    </footer>

    <div id="qr-modal" class="fixed inset-0 bg-black bg-opacity-50 flex items-center justify-center z-50 hidden">
        <div class="bg-white p-6 rounded-xl shadow-lg max-w-md w-full">
            <div class="flex justify-between items-center mb-4">
                <h3 class="text-xl font-bold text-gray-800">QR Kod</h3>
                <button id="close-qr-modal" class="text-gray-500 hover:text-gray-800">
                    <i class="fas fa-times text-xl"></i>
                </button>
            </div>
            <div id="modal-qrcode-container" class="flex justify-center mb-6"></div>
            <div class="text-center text-gray-700 mb-6">
                <p class="mb-2">Bu QR kodu tarayarak listeye erişebilirsiniz.</p>
                <p id="qr-list-id" class="font-mono bg-gray-100 p-2 rounded"></p>
            </div>
            <div class="flex space-x-2">
                <button id="modal-download-qr" class="flex-1 bg-primary text-white py-2 rounded-lg hover-bg-primary transition-all">
                    <i class="fas fa-download mr-2"></i> QR Kodu İndir
                </button>
                <button id="copy-list-id" class="flex-1 bg-gray-200 text-gray-800 py-2 rounded-lg hover:bg-gray-300 transition-all">
                    <i class="fas fa-copy mr-2"></i> ID Kopyala
                </button>
            </div>
        </div>
    </div>

    <div id="alert" class="fixed bottom-4 right-4 max-w-xs bg-white rounded-lg shadow-lg overflow-hidden transform transition-all duration-300 translate-y-20 opacity-0">
        <div class="p-4">
            <div class="flex items-start">
                <div id="alert-icon" class="flex-shrink-0">
                    <i class="fas fa-check-circle text-green-500 text-xl"></i>
                </div>
                <div class="ml-3 w-0 flex-1">
                    <p id="alert-message" class="text-sm font-medium text-gray-800">
                        İşlem başarıyla tamamlandı.
                    </p>
                </div>
                <div class="ml-4 flex-shrink-0 flex">
                    <button id="close-alert" class="inline-flex text-gray-400 hover:text-gray-500">
                        <i class="fas fa-times"></i>
                    </button>
                </div>
            </div>
        </div>
        <div id="alert-progress" class="h-1 bg-green-500"></div>
    </div>

    <script>
        // Firebase Configuration - Bu bilgiler doğrudan kod içine gömülmüştür.
        // Canvas ortamında otomatik sağlanan değerler yerine, sizin belirttiğiniz değerler kullanılmaktadır.
        const firebaseConfig = {
            apiKey: "AIzaSyCGG5Ur3YpVxbtkjooMxE6r7RPuAmZoFRI",
            authDomain: "anonim-not.firebaseapp.com",
            projectId: "anonim-not",
            storageBucket: "anonim-not.appspot.com",
            messagingSenderId: "1020793266706",
            appId: "1:1020793266706:web:bdaba147c8367a50dfaecb"
        };
        // Uygulama kimliği Firebase yapılandırmasından alınmıştır.
        const appId = firebaseConfig.projectId; 

        // Initialize Firebase
        const app = firebase.initializeApp(firebaseConfig);
        const auth = firebase.auth();
        const db = firebase.firestore();
        const storage = firebase.storage();
        
        // Global Variables (declared first)
        let currentUser = null;
        let userId = null;
        let currentListId = null;
        let currentListItems = JSON.parse(localStorage.getItem('draftItems')) || [];
        let editingListId = null;
        let editingListItems = [];
        let publicListId = null;
        let publicListItems = [];
        let qrScanner = null;
        let alertTimeout; // Variable for alert timeout

        // Imgur Client ID (replace with your actual client ID)
        const IMGUR_CLIENT_ID = "895f27f2c7a23be"; // Your Imgur Client ID

        // --- Core Functions (defined here to be globally available for inline onclicks) ---

        // Show Page
        function showPage(pageId) {
            console.log(`Attempting to show page: ${pageId}`);
            // Ensure pages are loaded before accessing them
            const pages = document.querySelectorAll('.page'); // Re-query pages here to ensure it's always up-to-date
            pages.forEach(page => {
                if (page.id === pageId) {
                    page.classList.remove('hidden');
                    console.log(`Page ${pageId} shown.`);
                } else {
                    page.classList.add('hidden');
                }
            });
            
            const mobileMenu = document.getElementById('mobile-menu'); // Re-query here too
            if (mobileMenu && !mobileMenu.classList.contains('hidden')) {
                mobileMenu.classList.add('hidden');
                console.log("Mobile menu hidden.");
            }
            
            window.scrollTo(0, 0);

            if (pageId === 'dashboard' && currentUser) {
                loadUserLists();
                console.log("Loading user lists for dashboard.");
            } else if (pageId === 'createList') {
                currentListItems = JSON.parse(localStorage.getItem('draftItems')) || [];
                renderCurrentListItems();
                // Ensure list-name input is cleared when showing createList page
                const listNameInput = document.getElementById('list-name');
                if (listNameInput) listNameInput.value = '';
                const itemNameInput = document.getElementById('item-name');
                if (itemNameInput) itemNameInput.value = '';
                const itemQuantityInput = document.getElementById('item-quantity');
                if (itemQuantityInput) itemQuantityInput.value = '';
                const itemImageInput = document.getElementById('item-image');
                if (itemImageInput) itemImageInput.value = '';
                const imageErrorElement = document.getElementById('imageError');
                if (imageErrorElement) imageErrorElement.textContent = '';
                console.log("Resetting createList form and rendering draft items.");
            }
        }
        
        // Toggle Mobile Menu
        function toggleMobileMenu() {
            console.log("toggleMobileMenu called.");
            const mobileMenu = document.getElementById('mobile-menu'); // Re-query here
            mobileMenu.classList.toggle('hidden');
            console.log("Mobile menu hidden status:", mobileMenu.classList.contains('hidden'));
        }

        // Logout Handler
        async function logout() {
            try {
                await auth.signOut();
                showAlert('Çıkış yapıldı!', 'success');
                showPage('home');
            } catch (error) {
                showAlert('Çıkış yaparken bir hata oluştu: ' + error.message, 'error');
            }
        }

        // List Deletion Confirmation
        function confirmDeleteList(listId) {
            if (confirm('Bu listeyi silmek istediğinizden emin misiniz? Bu işlem geri alınamaz.')) {
                deleteList(listId);
            }
        }

        // Cancel Edit
        function cancelEdit() {
            editingListId = null;
            editingListItems = [];
            showPage('viewList');
            displayListDetails(currentListId);
        }

        // Cancel Public Edit
        function cancelPublicEdit() {
            showPage('publicList');
            loadPublicList(publicListId);
        }

        // View List by ID from scanner input
        function viewListById() {
            const listId = document.getElementById('list-id-input').value.trim();
            if (listId) {
                loadPublicList(listId);
            } else {
                showAlert('Lütfen bir Liste ID girin veya QR kod tarayın.', 'error');
            }
        }

        // QR Scanner
        function initQrScanner() {
            showPage('qrScanner');
            const qrVideo = document.getElementById('qr-video');
            const qrScannerContainer = document.getElementById('qr-scanner-container');

            if (qrScanner) {
                qrScanner.destroy(); // Destroy previous scanner instance
            }

            qrScannerContainer.classList.remove('hidden'); // Show scanner container

            // Check if environment is suitable for camera access
            Html5Qrcode.getCameras().then(devices => {
                if (devices && devices.length) {
                    const cameraId = devices[0].id; // Use the first camera
                    qrScanner = new Html5Qrcode("qr-video");
                    qrScanner.start(
                            cameraId, {
                                fps: 10, // Frames per second
                                qrbox: {
                                    width: 250,
                                    height: 250
                                } // Scan area
                            },
                            (decodedText, decodedResult) => {
                                // On successful scan
                                if (decodedText) {
                                    qrScanner.stop(); // Stop scanner
                                    // Extract list ID from URL or use text directly
                                    document.getElementById('list-id-input').value = decodedText.split('?list=')[1] || decodedText; 
                                    showAlert('QR kod tarandı!', 'success');
                                    qrScannerContainer.classList.add('hidden'); // Hide scanner container
                                }
                            },
                            (errorMessage) => {
                                // On error (optional)
                                // console.log(`QR Scan Error: ${errorMessage}`);
                            })
                        .catch((err) => {
                            showAlert('Kamera başlatılırken hata oluştu: ' + err, 'error');
                            console.error("Error starting QR scanner:", err);
                        });
                } else {
                    showAlert('Kamera bulunamadı.', 'error');
                    qrScannerContainer.classList.add('hidden');
                }
            }).catch(err => {
                showAlert('Kamera erişim hatası: ' + err, 'error');
                qrScannerContainer.classList.add('hidden');
            });
        }

        // --- End of Core Functions ---

        // DOM Elements (These will be assigned when the script runs, after the functions above are defined)
        const mobileMenuButton = document.getElementById('mobile-menu-button');
        const mainNav = document.getElementById('main-nav');
        const loginForm = document.getElementById('login-form');
        const registerForm = document.getElementById('register-form');
        const addItemButton = document.getElementById('add-item');
        const saveListButton = document.getElementById('save-list');
        const editListButton = document.getElementById('edit-list');
        const updateListButton = document.getElementById('update-list');
        const qrModal = document.getElementById('qr-modal');
        const closeQrModalButton = document.getElementById('close-qr-modal');
        const modalDownloadQrButton = document.getElementById('modal-download-qr');
        const copyListIdButton = document.getElementById('copy-list-id');
        const downloadQrButton = document.getElementById('download-qr');
        const editPublicListButton = document.getElementById('edit-public-list');
        const updatePublicListButton = document.getElementById('update-public-list');
        const editPublicAddItemButton = document.getElementById('edit-public-add-item');
        const scanQrButton = document.getElementById('scan-qr-button');
        const viewListButtonElem = document.getElementById('view-list-button'); // Renamed to avoid conflict with function
        const contactForm = document.getElementById('contact-form');
        const alert = document.getElementById('alert');
        const alertIcon = document.getElementById('alert-icon');
        const alertMessage = document.getElementById('alert-message');
        const alertProgress = document.getElementById('alert-progress');
        const closeAlertButton = document.getElementById('close-alert');


        // Event Listeners (These will be added after DOM elements are available)
        // Ensure event listeners are added only if elements exist
        document.addEventListener('DOMContentLoaded', initApp); 
        if (mobileMenuButton) mobileMenuButton.addEventListener('click', toggleMobileMenu);
        if (loginForm) loginForm.addEventListener('submit', handleLogin);
        if (registerForm) registerForm.addEventListener('submit', handleRegister);
        if (addItemButton) addItemButton.addEventListener('click', addItemToList);
        if (saveListButton) saveListButton.addEventListener('click', saveList);
        if (editListButton) editListButton.addEventListener('click', editList);
        if (updateListButton) updateListButton.addEventListener('click', updateList);
        if (closeQrModalButton) closeQrModalButton.addEventListener('click', closeQrModal);
        if (modalDownloadQrButton) modalDownloadQrButton.addEventListener('click', downloadQrCode);
        if (copyListIdButton) copyListIdButton.addEventListener('click', copyListId);
        if (downloadQrButton) downloadQrButton.addEventListener('click', downloadQrCode);
        if (editPublicListButton) editPublicListButton.addEventListener('click', editPublicList);
        if (updatePublicListButton) updatePublicListButton.addEventListener('click', updatePublicList);
        if (editPublicAddItemButton) editPublicAddItemButton.addEventListener('click', addItemToPublicList);
        if (scanQrButton) scanQrButton.addEventListener('click', initQrScanner);
        if (viewListButtonElem) viewListButtonElem.addEventListener('click', viewListById); // Use renamed element
        const editAddItemElem = document.getElementById('edit-add-item');
        if (editAddItemElem) editAddItemElem.addEventListener('click', addItemToEditList);
        if (contactForm) contactForm.addEventListener('submit', handleContactForm);
        if (closeAlertButton) closeAlertButton.addEventListener('click', hideAlert);

        // Show loading indicator (for image uploads)
        function showLoading() {
            // You can implement a loading spinner or message here
            // For example, by adding a hidden div with a spinner and showing it
            console.log("Loading...");
        }

        // Hide loading indicator
        function hideLoading() {
            // Hide the loading spinner/message
            console.log("Loading finished.");
        }

        // Test Imgur connection
        async function checkImgurStatus() {
            try {
                const response = await fetch("https://api.imgur.com/3/credits", {
                    headers: { "Authorization": `Client-ID ${IMGUR_CLIENT_ID}` }
                });
                const data = await response.json();
                console.log("Imgur API Status:", data);
                if (!data.success) {
                    console.warn("Imgur API Limits:", data.data);
                }
            } catch (error) {
                console.error("Imgur Connection Error:", error);
            }
        }

        // Upload image to Imgur
        async function uploadImageToImgur(file, errorElementId) {
            showLoading();
            const errorElement = document.getElementById(errorElementId);
            if (errorElement) errorElement.textContent = "";

            // File size check (10MB)
            if (file.size > 10 * 1024 * 1024) {
                hideLoading();
                if (errorElement) errorElement.textContent = "Resim boyutu 10MB'tan küçük olmalı!";
                showAlert("Resim boyutu 10MB'tan küçük olmalı!", "error");
                throw new Error("File size exceeded");
            }

            const formData = new FormData();
            formData.append("image", file);

            try {
                const response = await fetch("https://api.imgur.com/3/image", {
                    method: "POST",
                    headers: {
                        "Authorization": `Client-ID ${IMGUR_CLIENT_ID}`
                    },
                    body: formData
                });

                const data = await response.json();
                if (!data.success) {
                    throw new Error(data.data.error || "Imgur upload error");
                }
                return data.data.link;
            } catch (error) {
                console.error("Imgur Error:", {
                    error: error.message,
                    stack: error.stack
                });
                if (errorElement) errorElement.textContent = "Resim yüklenemedi: " + error.message;
                showAlert("Resim yüklenemedi: " + error.message, "error");
                throw error;
            } finally {
                hideLoading();
            }
        }

        // Initialize the Application
        async function initApp() {
            console.log("initApp called.");
            try {
                // Eğer mevcut bir kullanıcı yoksa anonim olarak giriş yapmayı deniyoruz.
                // auth/admin-restricted-operation hatasını yakalamak için özel kontrol
                if (!auth.currentUser) {
                    try {
                        console.log("Mevcut kullanıcı yok. Firebase anonim giriş denemesi...");
                        await auth.signInAnonymously();
                        console.log("Firebase anonim giriş başarılı.");
                    } catch (anonError) {
                        if (anonError.code === "auth/admin-restricted-operation") {
                            console.warn("Anonim giriş kısıtlandı. Firebase konsolunuzda 'Anonim' sağlayıcıyı etkinleştirmelisiniz.");
                            showAlert("Anonim giriş kısıtlandı. Lütfen Firebase projenizde 'Anonim' sağlayıcıyı etkinleştirin veya e-posta/şifre ile giriş yapın.", "error");
                        } else {
                            console.error("Anonim giriş sırasında beklenmeyen hata:", anonError);
                            showAlert("Anonim giriş hatası: " + anonError.message, "error");
                        }
                        // Anonim giriş başarısız olsa bile uygulamanın devam etmesini sağla
                    }
                } else {
                    console.log("Kullanıcı zaten oturum açmış:", auth.currentUser.uid);
                }
            } catch (error) {
                console.error("initApp sırasında genel Firebase kimlik doğrulama hatası:", error);
                showAlert("Firebase kimlik doğrulama hatası: " + error.message, "error");
            }

            // Kullanıcı kimlik doğrulama durumu değişikliklerini dinle
            auth.onAuthStateChanged(user => {
                console.log("onAuthStateChanged tetiklendi. Kullanıcı:", user ? user.uid : "boş (oturum açılmamış)");
                currentUser = user; // Mevcut kullanıcıyı ayarla
                userId = user ? user.uid : crypto.randomUUID(); // userId'yi kimlik doğrulama durumuna göre ayarla
                console.log("Mevcut userId:", userId);
                updateAuthUI(); // Kimlik doğrulama durumuna göre arayüzü güncelle
                
                if (user) {
                    console.log("Kullanıcı oturum açmış, kullanıcı listeleri yükleniyor.");
                    loadUserLists(); // Oturum açmışsa kullanıcı listelerini yükle
                }
                
                // URL'de liste kimliği olup olmadığını kontrol et (QR kodla paylaşılan listeler için)
                const urlParams = new URLSearchParams(window.location.search);
                const listId = urlParams.get('list');
                
                if (listId) {
                    console.log(`URL'de liste kimliği bulundu: ${listId}. Genel liste yükleniyor.`);
                    loadPublicList(listId); // Liste kimliği varsa genel listeyi yükle
                } else {
                    console.log("URL'de liste kimliği yok. Ana sayfa gösteriliyor.");
                    showPage('home'); // Aksi takdirde ana sayfayı göster
                }
            });

            checkImgurStatus(); // Uygulama başlangıcında Imgur bağlantısını test et
            renderCurrentListItems(); // localStorage'dan taslak öğeleri render et
        }
        
        // Update UI based on Authentication Status
        function updateAuthUI() {
            console.log("updateAuthUI called. currentUser:", currentUser ? currentUser.uid : "null (not logged in)");
            
            // Get navigation elements
            const mainNav = document.getElementById('main-nav');
            const mobileMenu = document.getElementById('mobile-menu');

            // Get all auth-dependent elements
            const authHideElements = document.querySelectorAll('.auth-hide');
            const authShowElements = document.querySelectorAll('.auth-show');
            
            if (currentUser) {
                console.log("User is logged in. Hiding auth-hide elements, showing auth-show elements.");
                
                // Show desktop nav and hide mobile nav if user is logged in
                if (mainNav) {
                    mainNav.classList.remove('hidden'); // Ensure main nav is visible
                    mainNav.classList.add('md:flex'); // Ensure it's flex on medium screens and up
                }
                // Mobile menu's visibility is controlled by the hamburger button, not directly by auth state,
                // but its *contents* (auth-hide/show links) are.
                // So, no change needed for mobileMenu's `hidden` class here, only for its children.

                authHideElements.forEach(el => {
                    el.classList.add('hidden');
                    console.log(`Element with class auth-hide hidden: ${el.tagName} ${el.textContent.trim().substring(0, 20)}...`);
                });
                authShowElements.forEach(el => {
                    el.classList.remove('hidden');
                    console.log(`Element with class auth-show shown: ${el.tagName} ${el.textContent.trim().substring(0, 20)}...`);
                });
            } else {
                console.log("User is NOT logged in. Showing auth-hide elements, hiding auth-show elements.");
                
                // Hide desktop nav and show mobile nav if user is not logged in
                if (mainNav) {
                    mainNav.classList.add('hidden'); // Hide main nav
                    mainNav.classList.remove('md:flex'); // Remove flex property
                }
                // Mobile menu's visibility is controlled by the hamburger button, not directly by auth state,
                // but its *contents* (auth-hide/show links) are.
                // So, no change needed for mobileMenu's `hidden` class here, only for its children.

                authHideElements.forEach(el => {
                    el.classList.remove('hidden');
                    console.log(`Element with class auth-hide shown: ${el.tagName} ${el.textContent.trim().substring(0, 20)}...`);
                });
                authShowElements.forEach(el => {
                    el.classList.add('hidden');
                    console.log(`Element with class auth-show hidden: ${el.tagName} ${el.textContent.trim().substring(0, 20)}...`);
                });
            }
        }
        
        // Show Alert Message
        function showAlert(message, type = 'success') {
            clearTimeout(alertTimeout); // Clear existing timeout

            alertMessage.textContent = message; // Set message
            if (type === 'success') {
                alertIcon.innerHTML = '<i class="fas fa-check-circle text-green-500 text-xl"></i>'; // Success icon
                alertProgress.classList.remove('bg-red-500');
                alertProgress.classList.add('bg-green-500');
            } else {
                alertIcon.innerHTML = '<i class="fas fa-times-circle text-red-500 text-xl"></i>'; // Error icon
                alertProgress.classList.remove('bg-green-500');
                alertProgress.classList.add('bg-red-500');
            }

            alert.classList.remove('translate-y-20', 'opacity-0'); // Make alert visible
            alert.classList.add('translate-y-0', 'opacity-100');

            alertProgress.style.width = '100%'; // Start progress bar
            alertProgress.style.transition = 'width 4s linear'; // Progress animation

            alertTimeout = setTimeout(() => {
                hideAlert(); // Hide alert after a certain duration
            }, 4000);
        }

        // Hide Alert Message
        function hideAlert() {
            alert.classList.remove('translate-y-0', 'opacity-100'); // Hide alert
            alert.classList.add('translate-y-20', 'opacity-0');
            alertProgress.style.transition = 'none'; // Reset transition
            alertProgress.style.width = '0%'; // Reset width
        }

        // User Authentication Operations

        // Login Handler
        async function handleLogin(e) {
            e.preventDefault(); // Prevent default form submission
            const email = loginForm['login-email'].value;
            const password = loginForm['login-password'].value;
            const loginError = document.getElementById('login-error');

            try {
                await auth.signInWithEmailAndPassword(email, password); // Log in with Firebase
                showAlert('Giriş başarılı!', 'success');
                loginError.classList.add('hidden'); // Hide error message
                showPage('dashboard'); // Redirect to Dashboard page
            } catch (error) {
                loginError.textContent = 'Giriş başarısız: ' + error.message; // Show error message
                loginError.classList.remove('hidden');
                showAlert('Giriş başarısız!', 'error');
            }
        }

        // Register Handler
        async function handleRegister(e) {
            e.preventDefault(); // Prevent default form submission
            const name = registerForm['register-name'].value;
            const email = registerForm['register-email'].value;
            const password = registerForm['register-password'].value;
            const registerError = document.getElementById('register-error');

            try {
                const userCredential = await auth.createUserWithEmailAndPassword(email, password); // Create user with Firebase
                await userCredential.user.updateProfile({ displayName: name }); // Update user display name
                showAlert('Kayıt başarılı! Giriş yapılıyor...', 'success');
                registerError.classList.add('hidden'); // Hide error message
                showPage('dashboard'); // Redirect to Dashboard page
            } catch (error) {
                registerError.textContent = 'Kayıt başarısız: ' + error.message; // Show error message
                registerError.classList.remove('hidden');
                showAlert('Kayıt başarısız!', 'error');
            }
        }

        // List Management (Create, View, Edit, Delete)

        // Add Item to Current List (for Create List Page)
        async function addItemToList() {
            console.log("addItemToList called.");
            const itemNameInput = document.getElementById('item-name');
            const itemQuantityInput = document.getElementById('item-quantity');
            const itemImageInput = document.getElementById('item-image');

            const name = itemNameInput.value.trim();
            const quantity = itemQuantityInput.value.trim();
            const imageFile = itemImageInput.files[0];

            console.log("Item Name:", name);
            console.log("Item Quantity:", quantity);
            console.log("Image File:", imageFile);

            if (!name) {
                showAlert('Lütfen öğe adını girin.', 'error');
                console.log("Item name is empty, returning.");
                return;
            }

            let imageUrl = null;
            if (imageFile) {
                console.log("Image file detected, attempting upload to Imgur...");
                try {
                    imageUrl = await uploadImageToImgur(imageFile, 'imageError');
                    console.log("Imgur upload successful, URL:", imageUrl);
                } catch (error) {
                    console.error("Imgur upload failed:", error);
                    // Error message already shown by uploadImageToImgur
                    return; 
                }
            }

            currentListItems.push({ name, quantity, imageUrl, checked: false }); // Add item to the list
            console.log("currentListItems after push:", currentListItems);
            localStorage.setItem('draftItems', JSON.stringify(currentListItems)); // Save draft to localStorage
            console.log("Draft items saved to localStorage.");
            renderCurrentListItems(); // Re-render the list
            console.log("renderCurrentListItems called.");

            // Clear input fields
            itemNameInput.value = '';
            itemQuantityInput.value = '';
            itemImageInput.value = '';
            document.getElementById('imageError').textContent = '';
            showAlert('Öğe listeye eklendi.', 'success');
            console.log("Item added successfully alert shown.");
        }

        // Render Current List Items (for Create List Page)
        function renderCurrentListItems() {
            console.log("renderCurrentListItems called. Items to render:", currentListItems);
            const itemListDiv = document.getElementById('item-list');
            const emptyListMessage = document.getElementById('empty-list-message'); // Şimdi bu öğe her zaman erişilebilir olacak

            itemListDiv.innerHTML = ''; // Sadece öğeleri temizle

            if (currentListItems.length === 0) {
                emptyListMessage.classList.remove('hidden'); // Liste boşsa mesajı göster
                console.log("currentListItems is empty, showing empty message.");
            } else {
                emptyListMessage.classList.add('hidden'); // Liste doluysa mesajı gizle
            }

            currentListItems.forEach((item, index) => {
                console.log(`Rendering item ${index}:`, item);
                const itemDiv = document.createElement('div');
                itemDiv.className = 'flex items-center justify-between bg-gray-50 p-3 rounded-lg mb-2';
                itemDiv.innerHTML = `
                    <div class="flex items-center flex-1">
                        ${item.imageUrl ? `<img src="${item.imageUrl}" class="w-12 h-12 object-cover rounded-md mr-4" alt="Öğe Resmi">` : '<i class="fas fa-box text-2xl text-gray-400 mr-4"></i>'}
                        <div>
                            <p class="font-medium text-gray-800">${item.name}</p>
                            <p class="text-sm text-gray-600">${item.quantity || 'Miktar belirtilmemiş'}</p>
                        </div>
                    </div>
                    <button class="text-red-500 hover:text-red-700 ml-4" onclick="removeItemFromList(${index}, 'current')">
                        <i class="fas fa-trash"></i>
                    </button>
                `;
                itemListDiv.appendChild(itemDiv);
            });
            console.log("Finished rendering items.");
        }

        // Remove Item from List
        function removeItemFromList(index, listType) {
            if (listType === 'current') {
                currentListItems.splice(index, 1); // Remove item from current list
                localStorage.setItem('draftItems', JSON.stringify(currentListItems)); // Update localStorage
                renderCurrentListItems();
            } else if (listType === 'edit') {
                editingListItems.splice(index, 1); // Remove item from edit list
                renderEditListItems();
            } else if (listType === 'publicEdit') {
                publicListItems.splice(index, 1); // Remove item from public edit list
                renderPublicEditListItems();
            }
            showAlert('Öğe listeden kaldırıldı.', 'success');
        }

        // Save List (Create List Page)
        async function saveList() {
            if (!currentUser) {
                showAlert('Lütfen önce giriş yapın', 'error');
                showPage('login');
                return;
            }
            
            const listName = document.getElementById('list-name').value.trim();
            
            if (!listName) {
                showAlert('Lütfen liste adını girin', 'error');
                return;
            }
            
            if (currentListItems.length === 0) {
                showAlert('Lütfen listeye en az bir öğe ekleyin', 'error');
                return;
            }
            
            try {
                // Check if user has reached list limit (max 4 lists)
                const userListsRef = db.collection(`artifacts/${appId}/users/${userId}/lists`);
                const snapshot = await userListsRef.get();
                
                if (snapshot.size >= 4) {
                    showAlert('Maksimum liste sayısına ulaştınız (4/4)', 'error');
                    return;
                }
                
                // Save list to Firestore
                const docRef = await userListsRef.add({
                    userId: userId,
                    name: listName,
                    items: currentListItems, // Items already have imageUrl from Imgur upload
                    createdAt: firebase.firestore.FieldValue.serverTimestamp(),
                    updatedAt: firebase.firestore.FieldValue.serverTimestamp()
                });
                
                currentListId = docRef.id; // Set the ID of the newly created list
                localStorage.removeItem('draftItems'); // Clear draft items after saving
                showAlert('Liste başarıyla kaydedildi!', 'success');
                showPage('viewList'); // Redirect to view page
                displayListDetails(currentListId); // Display the newly created list
            } catch (error) {
                showAlert('Liste kaydedilirken bir hata oluştu: ' + error.message, 'error');
                console.error("Error saving list: ", error);
            }
        }

        // Load User Lists (Dashboard Page)
        async function loadUserLists() {
            if (!currentUser) {
                return;
            }

            const userListsDiv = document.getElementById('user-lists');
            userListsDiv.innerHTML = ''; // Clear existing lists
            document.getElementById('no-lists-message').classList.add('hidden'); // Hide empty list message
            document.getElementById('qr-list-counter').textContent = ''; // Clear list counter

            try {
                // Get user's lists ordered by creation date
                const listsRef = db.collection(`artifacts/${appId}/users/${userId}/lists`).orderBy('createdAt', 'desc'); 
                const snapshot = await listsRef.get();

                if (snapshot.empty) {
                    document.getElementById('no-lists-message').classList.remove('hidden'); // Show message if list is empty
                    return;
                }

                document.getElementById('qr-list-counter').textContent = `Toplam ${snapshot.size}/4 liste`; // Update list counter

                snapshot.forEach(doc => {
                    const list = doc.data();
                    const listId = doc.id;

                    const listCard = document.createElement('div');
                    listCard.className = 'bg-white p-6 rounded-xl shadow-md flex flex-col justify-between';
                    listCard.innerHTML = `
                        <div>
                            <h3 class="text-xl font-bold text-gray-800 mb-2">${list.name}</h3>
                            <p class="text-sm text-gray-600 mb-4">${list.items ? list.items.length : 0} öğe</p>
                        </div>
                        <div class="flex space-x-2 mt-4">
                            <button onclick="displayListDetails('${listId}')" class="flex-1 bg-primary text-white px-4 py-2 rounded-lg hover-bg-primary transition-all text-sm">
                                <i class="fas fa-eye mr-2"></i> Görüntüle
                            </button>
                            <button onclick="confirmDeleteList('${listId}')" class="flex-1 bg-red-500 text-white px-4 py-2 rounded-lg hover:bg-red-600 transition-all text-sm">
                                <i class="fas fa-trash mr-2"></i> Sil
                            </button>
                        </div>
                    `;
                    userListsDiv.appendChild(listCard);
                });
            } catch (error) {
                showAlert('Listeler yüklenirken bir hata oluştu: ' + error.message, 'error');
                console.error("Error loading user lists: ", error);
            }
        }

        // Display List Details (View List Page)
        async function displayListDetails(listId) {
            currentListId = listId; // Set current list ID
            showPage('viewList'); // Redirect to view page
            const viewListName = document.getElementById('view-list-name');
            const viewItemList = document.getElementById('view-item-list');
            const qrcodeContainer = document.getElementById('qrcode-container');

            viewListName.textContent = 'Liste Yükleniyor...';
            viewItemList.innerHTML = '';
            
            // QR kod konteynerini temizle ve varlığını kontrol et
            if (qrcodeContainer) {
                qrcodeContainer.innerHTML = '';
            } else {
                console.error("QR Kod Konteyneri (qrcode-container) bulunamadı!");
                showAlert('QR kod alanı bulunamadı.', 'error');
                return; // Konteyner yoksa devam etme
            }

            try {
                const listDoc = await db.collection(`artifacts/${appId}/users/${userId}/lists`).doc(listId).get(); // Get list from Firestore
                if (!listDoc.exists) {
                    showAlert('Liste bulunamadı.', 'error');
                    showPage('dashboard');
                    return;
                }

                const list = listDoc.data();
                viewListName.textContent = list.name;
                currentListItems = list.items || []; // Update global currentListItems

                if (currentListItems.length === 0) {
                    viewItemList.innerHTML = '<p class="text-center py-8 text-gray-500"><i class="fas fa-clipboard text-4xl mb-3"></i><p>Bu listede hiç öğe yok.</p></p>';
                } else {
                    currentListItems.forEach(item => {
                        const itemDiv = document.createElement('div');
                        itemDiv.className = 'flex items-center bg-gray-50 p-3 rounded-lg mb-2';
                        itemDiv.innerHTML = `
                            <input type="checkbox" ${item.checked ? 'checked' : ''} class="form-checkbox h-5 w-5 text-primary mr-4" onchange="toggleItemChecked('${listId}', '${item.name}', event.target.checked)">
                            ${item.imageUrl ? `<img src="${item.imageUrl}" class="w-12 h-12 object-cover rounded-md mr-4" alt="Öğe Resmi">` : '<i class="fas fa-box text-2xl text-gray-400 mr-4"></i>'}
                            <div class="flex-1">
                                <p class="font-medium text-gray-800 ${item.checked ? 'line-through text-gray-500' : ''}">${item.name}</p>
                                <p class="text-sm text-gray-600">${item.quantity || 'Miktar belirtilmemiş'}</p>
                            </div>
                        `;
                        viewItemList.appendChild(itemDiv);
                    });
                }

                // Generate QR Code
                const qrCodeUrl = `${window.location.origin}?list=${listId}`; // URL containing list ID
                console.log("QR Kod için URL oluşturuluyor:", qrCodeUrl); // Hata ayıklama logu
                try {
                    new QRCode(qrcodeContainer, {
                        text: qrCodeUrl,
                        width: 200,
                        height: 200,
                        colorDark: "#4f46e5",
                        colorLight: "#ffffff",
                        correctLevel: QRCode.CorrectLevel.H
                    });
                    console.log("QR Kod başarıyla oluşturuldu.");
                } catch (qrError) {
                    console.error("QRCode.js ile QR Kod oluşturulurken hata oluştu:", qrError);
                    showAlert('QR kod oluşturulurken bir hata oluştu.', 'error');
                }

            } catch (error) {
                showAlert('Liste detayları yüklenirken bir hata oluştu: ' + error.message, 'error');
                console.error("Error displaying list details: ", error);
                showPage('dashboard');
            }
        }

        // Toggle Item Checked Status
        async function toggleItemChecked(listId, itemName, isChecked) {
            try {
                const listDoc = await db.collection(`artifacts/${appId}/users/${userId}/lists`).doc(listId).get();
                if (!listDoc.exists) return;

                const listData = listDoc.data();
                const updatedItems = listData.items.map(item =>
                    item.name === itemName ? { ...item, checked: isChecked } : item
                );

                await db.collection(`artifacts/${appId}/users/${userId}/lists`).doc(listId).update({ items: updatedItems }); // Update item status in Firestore
                showAlert('Liste öğesi güncellendi.', 'success');
                displayListDetails(listId); // Re-render list to reflect changes
            } catch (error) {
                showAlert('Öğe durumu güncellenirken bir hata oluştu: ' + error.message, 'error');
                console.error("Error updating item checked status: ", error);
            }
        }

        // Edit List (from View List Page)
        async function editList() {
            if (!currentListId) {
                showAlert('Düzenlenecek bir liste seçilmedi.', 'error');
                return;
            }

            showPage('editList'); // Redirect to edit page
            const editListNameInput = document.getElementById('edit-list-name');
            const editListIdPara = document.getElementById('edit-list-id');

            editListIdPara.textContent = `Liste ID: ${currentListId}`;

            try {
                const listDoc = await db.collection(`artifacts/${appId}/users/${userId}/lists`).doc(currentListId).get(); // Get list from Firestore
                if (!listDoc.exists) {
                    showAlert('Düzenlenecek liste bulunamadı.', 'error');
                    showPage('dashboard');
                    return;
                }

                const list = listDoc.data();
                editListNameInput.value = list.name;
                editingListItems = list.items || []; // Assign current list items to editing list
                renderEditListItems(); // Render the edit list
                editingListId = currentListId; // Set the ID of the list being edited
            } catch (error) {
                showAlert('Liste düzenleme formu yüklenirken bir hata oluştu: ' + error.message, 'error');
                console.error("Error loading list edit form: ", error);
                showPage('viewList');
            }
        }

        // Add Item to Edit List
        async function addItemToEditList() {
            const itemNameInput = document.getElementById('edit-item-name');
            const itemQuantityInput = document.getElementById('edit-item-quantity'); // Corrected typo here
            const itemImageInput = document.getElementById('edit-item-image');

            const name = itemNameInput.value.trim();
            const quantity = itemQuantityInput.value.trim();
            const imageFile = itemImageInput.files[0];

            if (!name) {
                showAlert('Lütfen öğe adını girin.', 'error');
                return;
            }

            let imageUrl = null;
            if (imageFile) {
                try {
                    imageUrl = await uploadImageToImgur(imageFile, 'editImageError');
                } catch (error) {
                    return; 
                }
            }

            editingListItems.push({ name, quantity, imageUrl, checked: false }); // Add item to edit list
            renderEditListItems(); // Re-render the edit list

            // Clear input fields
            itemNameInput.value = '';
            itemQuantityInput.value = '';
            itemImageInput.value = '';
            document.getElementById('editImageError').textContent = '';
            showAlert('Öğe düzenleme listesine eklendi.', 'success');
        }

        // Render Edit List Items
        function renderEditListItems() {
            const editItemListDiv = document.getElementById('edit-item-list');
            editItemListDiv.innerHTML = ''; // Clear existing items

            if (editingListItems.length === 0) {
                editItemListDiv.innerHTML = '<p class="text-center py-8 text-gray-500"><i class="fas fa-clipboard text-4xl mb-3"></i><p>Henüz öğe eklemediniz.</p></p>';
                return;
            }

            editingListItems.forEach((item, index) => {
                const itemDiv = document.createElement('div');
                itemDiv.className = 'flex items-center justify-between bg-gray-50 p-3 rounded-lg mb-2';
                itemDiv.innerHTML = `
                    <div class="flex items-center flex-1">
                        ${item.imageUrl ? `<img src="${item.imageUrl}" class="w-12 h-12 object-cover rounded-md mr-4" alt="Öğe Resmi">` : '<i class="fas fa-box text-2xl text-gray-400 mr-4"></i>'}
                        <div>
                            <p class="font-medium text-gray-800">${item.name}</p>
                            <p class="text-sm text-gray-600">${item.quantity || 'Miktar belirtilmemiş'}</p>
                        </div>
                    </div>
                    <button class="text-red-500 hover:text-red-700 ml-4" onclick="removeItemFromList(${index}, 'edit')">
                        <i class="fas fa-trash"></i>
                    </button>
                `;
                editItemListDiv.appendChild(itemDiv);
            });
        }

        // Update List
        async function updateList() {
            if (!editingListId) {
                showAlert('Güncellenecek bir liste seçilmedi.', 'error');
                return;
            }

            const listName = document.getElementById('edit-list-name').value.trim();

            if (!listName) {
                showAlert('Lütfen liste adını girin.', 'error');
                return;
            }

            if (editingListItems.length === 0) {
                showAlert('Lütfen listeye en az bir öğe ekleyin', 'error');
                return;
            }

            try {
                await db.collection(`artifacts/${appId}/users/${userId}/lists`).doc(editingListId).update({
                    name: listName,
                    items: editingListItems, // Items already have imageUrl from Imgur upload
                    updatedAt: firebase.firestore.FieldValue.serverTimestamp()
                });

                showAlert('Liste başarıyla güncellendi!', 'success');
                showPage('viewList'); // Redirect to view page
                displayListDetails(editingListId); // Show the updated list
                editingListId = null; // Clear editing ID
                editingListItems = []; // Clear editing items
            } catch (error) {
                showAlert('Liste güncellenirken bir hata oluştu: ' + error.message, 'error');
                console.error("Error updating list: ", error);
            }
        }

        // List Deletion Confirmation
        function confirmDeleteList(listId) {
            // Using a simple confirmation window. A more advanced modal can be used.
            if (confirm('Bu listeyi silmek istediğinizden emin misiniz? Bu işlem geri alınamaz.')) {
                deleteList(listId);
            }
        }

        // Delete List
        async function deleteList(listId) {
            try {
                // Delete associated images in storage (optional but good practice)
                const listDoc = await db.collection(`artifacts/${appId}/users/${userId}/lists`).doc(listId).get();
                if (listDoc.exists) {
                    const listData = listDoc.data();
                    if (listData.items) {
                        for (const item of listData.items) {
                            if (item.imageUrl && item.imageUrl.includes('imgur.com')) {
                                // Imgur images are not managed by Firebase Storage, so no need to delete from Firebase Storage.
                                // If you were using Firebase Storage for images, you would delete them here.
                                console.log(`Imgur image: ${item.imageUrl} - not deleting from Firebase Storage.`);
                            } else if (item.imageUrl) {
                                try {
                                    // Assuming other images are in Firebase Storage
                                    const imageRef = storage.refFromURL(item.imageUrl);
                                    await imageRef.delete();
                                    console.log(`Firebase Storage image deleted: ${item.imageUrl}`);
                                } catch (imageError) {
                                    console.warn("Image could not be deleted (might not exist or permission issue):", imageError);
                                    // Continue even if image deletion fails
                                }
                            }
                        }
                    }
                }

                await db.collection(`artifacts/${appId}/users/${userId}/lists`).doc(listId).delete(); // Delete list from Firestore
                showAlert('Liste başarıyla silindi.', 'success');
                loadUserLists(); // Reload lists after deletion
            } catch (error) {
                showAlert('Liste silinirken bir hata oluştu: ' + error.message, 'error');
                console.error("Error deleting list: ", error);
            }
        }

        // QR Code Functions

        // Download QR Code
        function downloadQrCode() {
            let containerId = 'qrcode-container'; // Default for viewList page
            if (qrModal.classList.contains('flex')) { // If modal is open
                containerId = 'modal-qrcode-container';
            }

            const qrcodeSvg = document.getElementById(containerId).querySelector('svg'); // Get SVG element
            if (qrcodeSvg) {
                const serializer = new XMLSerializer();
                const svgString = serializer.serializeToString(qrcodeSvg); // Convert SVG to string

                const canvas = document.createElement('canvas');
                const ctx = canvas.getContext('2d');
                const img = new Image();

                img.onload = () => {
                    canvas.width = img.width;
                    canvas.height = img.height;
                    ctx.drawImage(img, 0, 0);

                    const a = document.createElement('a');
                    a.download = `QRListe_${currentListId || 'list'}.png`; // Set file name
                    a.href = canvas.toDataURL('image/png'); // Get canvas as PNG
                    a.click(); // Trigger download
                    showAlert('QR Kod indirildi!', 'success');
                };

                img.src = 'data:image/svg+xml;base64,' + btoa(svgString); // Create image from Base64 SVG
            } else {
                // QRCode.js bir SVG yerine bir tablo oluşturduğunda bu durum oluşabilir.
                // Tabloyu PNG'ye dönüştürmek daha karmaşıktır.
                // Eğer QR kod bir tablo olarak oluşturulduysa ve indirme isteniyorsa,
                // kullanıcıya doğrudan ekran görüntüsü almasını önerebiliriz veya daha gelişmiş bir dönüştürme yapabiliriz.
                showAlert('QR kod indirilemiyor. Lütfen ekran görüntüsü almayı deneyin.', 'error');
            }
        }

        // Open QR Modal (not directly used currently but a good function)
        function openQrModal(listId, qrCodeUrl) {
            document.getElementById('modal-qrcode-container').innerHTML = '';
            new QRCode(document.getElementById('modal-qrcode-container'), {
                text: qrCodeUrl,
                width: 200,
                height: 200,
                colorDark: "#4f46e5",
                colorLight: "#ffffff",
                correctLevel: QRCode.CorrectLevel.H
            });
            document.getElementById('qr-list-id').textContent = listId;
            qrModal.classList.remove('hidden');
            qrModal.classList.add('flex');
        }

        // Close QR Modal
        function closeQrModal() {
            qrModal.classList.add('hidden');
            qrModal.classList.remove('flex');
            document.getElementById('modal-qrcode-container').innerHTML = ''; // Clear QR code when modal closes
        }

        // Copy List ID
        function copyListId() {
            const listIdText = document.getElementById('qr-list-id').textContent;
            // Using document.execCommand('copy') because navigator.clipboard.writeText() might not work due to iframe restrictions.
            const tempInput = document.createElement('textarea');
            tempInput.value = listIdText;
            document.body.appendChild(tempInput);
            tempInput.select();
            document.execCommand('copy');
            document.body.removeChild(tempInput);
            showAlert('Liste ID kopyalandı!', 'success');
        }

        // Public List Viewing and Editing

        // Load Public List from URL
        async function loadPublicList(listId) {
            publicListId = listId; // Set public list ID
            showPage('publicList'); // Redirect to public list view page
            const publicListName = document.getElementById('public-list-name');
            const publicListIdPara = document.getElementById('public-list-id');
            const publicItemList = document.getElementById('public-item-list');

            publicListName.textContent = 'Liste Yükleniyor...';
            publicListIdPara.textContent = `Liste ID: ${listId}`;
            publicItemList.innerHTML = '';

            try {
                // Public lists are stored under /artifacts/${appId}/public/data/lists
                const listDoc = await db.collection(`artifacts/${appId}/public/data/lists`).doc(listId).get(); // Get list from Firestore
                if (!listDoc.exists) {
                    showAlert('Paylaşılan liste bulunamadı.', 'error');
                    showPage('home');
                    return;
                }

                const list = listDoc.data();
                publicListName.textContent = list.name;
                publicListItems = list.items || []; // Populate publicListItems

                if (publicListItems.length === 0) {
                    publicItemList.innerHTML = '<p class="text-center py-8 text-gray-500"><i class="fas fa-clipboard text-4xl mb-3"></i><p>Bu listede hiç öğe yok.</p></p>';
                } else {
                    publicListItems.forEach(item => {
                        const itemDiv = document.createElement('div');
                        itemDiv.className = 'flex items-center bg-gray-50 p-3 rounded-lg mb-2';
                        itemDiv.innerHTML = `
                            <input type="checkbox" ${item.checked ? 'checked' : ''} class="form-checkbox h-5 w-5 text-primary mr-4" onchange="togglePublicItemChecked('${listId}', '${item.name}', event.target.checked)">
                            ${item.imageUrl ? `<img src="${item.imageUrl}" class="w-12 h-12 object-cover rounded-md mr-4" alt="Öğe Resmi">` : '<i class="fas fa-box text-2xl text-gray-400 mr-4"></i>'}
                            <div class="flex-1">
                                <p class="font-medium text-gray-800 ${item.checked ? 'line-through text-gray-500' : ''}">${item.name}</p>
                                <p class="text-sm text-gray-600">${item.quantity || 'Miktar belirtilmemiş'}</p>
                            </div>
                        `;
                        publicItemList.appendChild(itemDiv);
                    });
                }
            } catch (error) {
                showAlert('Paylaşılan liste yüklenirken bir hata oluştu: ' + error.message, 'error');
                console.error("Error loading public list: ", error);
                showPage('home');
            }
        }

        // Toggle Public Item Checked Status
        async function togglePublicItemChecked(listId, itemName, isChecked) {
            try {
                // Public lists are stored under /artifacts/${appId}/public/data/lists
                const listDoc = await db.collection(`artifacts/${appId}/public/data/lists`).doc(listId).get();
                if (!listDoc.exists) return;

                const listData = listDoc.data();
                const updatedItems = listData.items.map(item =>
                    item.name === itemName ? { ...item, checked: isChecked } : item
                );

                await db.collection(`artifacts/${appId}/public/data/lists`).doc(listId).update({ items: updatedItems }); // Update item status in Firestore
                showAlert('Liste öğesi güncellendi.', 'success');
                loadPublicList(listId); // Re-render public list to reflect changes
            } catch (error) {
                showAlert('Öğe durumu güncellenirken bir hata oluştu: ' + error.message, 'error');
                console.error("Error updating public item checked status: ", error);
            }
        }

        // Edit Public List
        async function editPublicList() {
            if (!publicListId) {
                showAlert('Düzenlenecek bir genel liste seçilmedi.', 'error');
                return;
            }

            // Only allow editing if the current user is the owner of the list
            try {
                const listDoc = await db.collection(`artifacts/${appId}/public/data/lists`).doc(publicListId).get();
                if (!listDoc.exists || listDoc.data().userId !== userId) {
                    showAlert('Bu listeyi düzenleme yetkiniz yok.', 'error');
                    return;
                }
            } catch (error) {
                showAlert('Liste yetkisi kontrol edilirken hata oluştu: ' + error.message, 'error');
                console.error("Error checking public list permission: ", error);
                return;
            }


            showPage('editPublicList'); // Redirect to public list edit page
            const editPublicListNameInput = document.getElementById('edit-public-list-name');
            const editPublicListIdPara = document.getElementById('edit-public-list-id');

            editPublicListIdPara.textContent = `Liste ID: ${publicListId}`;

            try {
                const listDoc = await db.collection(`artifacts/${appId}/public/data/lists`).doc(publicListId).get(); // Get list from Firestore
                if (!listDoc.exists) {
                    showAlert('Düzenlenecek genel liste bulunamadı.', 'error');
                    showPage('publicList');
                    return;
                }

                const list = listDoc.data();
                editPublicListNameInput.value = list.name;
                publicListItems = list.items || []; // Populate publicListItems for editing
                renderPublicEditListItems(); // Render the public edit list
            } catch (error) {
                showAlert('Genel liste düzenleme formu yüklenirken bir hata oluştu: ' + error.message, 'error');
                console.error("Error loading public list edit form: ", error);
                showPage('publicList');
            }
        }

        // Add Item to Public Edit List
        async function addItemToPublicList() {
            const itemNameInput = document.getElementById('edit-public-item-name');
            const itemQuantityInput = document.getElementById('edit-public-item-quantity');
            const itemImageInput = document.getElementById('edit-public-item-image');

            const name = itemNameInput.value.trim();
            const quantity = itemQuantityInput.value.trim();
            const imageFile = itemImageInput.files[0];

            if (!name) {
                showAlert('Lütfen öğe adını girin.', 'error');
                return;
            }

            let imageUrl = null;
            if (imageFile) {
                try {
                    imageUrl = await uploadImageToImgur(imageFile, 'editPublicImageError');
                } catch (error) {
                    return;
                }
            }

            publicListItems.push({ name, quantity, imageUrl, checked: false }); // Add item to public list
            renderPublicEditListItems(); // Re-render the public edit list

            // Clear input fields
            itemNameInput.value = '';
            itemQuantityInput.value = '';
            itemImageInput.value = '';
            document.getElementById('editPublicImageError').textContent = '';
            showAlert('Öğe genel listeye eklendi.', 'success');
        }

        // Render Public Edit List Items
        function renderPublicEditListItems() {
            const editPublicItemListDiv = document.getElementById('edit-public-item-list');
            editPublicItemListDiv.innerHTML = ''; // Clear existing items

            if (publicListItems.length === 0) {
                editPublicItemListDiv.innerHTML = '<p class="text-center py-8 text-gray-500"><i class="fas fa-clipboard text-4xl mb-3"></i><p>Henüz öğe eklemediniz.</p></p>';
                return;
            }

            publicListItems.forEach((item, index) => {
                const itemDiv = document.createElement('div');
                itemDiv.className = 'flex items-center justify-between bg-gray-50 p-3 rounded-lg mb-2';
                itemDiv.innerHTML = `
                    <div class="flex items-center flex-1">
                        ${item.imageUrl ? `<img src="${item.imageUrl}" class="w-12 h-12 object-cover rounded-md mr-4" alt="Öğe Resmi">` : '<i class="fas fa-box text-2xl text-gray-400 mr-4"></i>'}
                        <div>
                            <p class="font-medium text-gray-800">${item.name}</p>
                            <p class="text-sm text-gray-600">${item.quantity || 'Miktar belirtilmemiş'}</p>
                        </div>
                    </div>
                    <button class="text-red-500 hover:text-red-700 ml-4" onclick="removeItemFromList(${index}, 'publicEdit')">
                        <i class="fas fa-trash"></i>
                    </button>
                `;
                editPublicItemListDiv.appendChild(itemDiv);
            });
        }

        // Update Public List
        async function updatePublicList() {
            if (!publicListId) {
                showAlert('Güncellenecek bir genel liste seçilmedi.', 'error');
                return;
            }

            const listName = document.getElementById('edit-public-list-name').value.trim();

            if (!listName) {
                showAlert('Lütfen liste adını girin.', 'error');
                return;
            }

            if (publicListItems.length === 0) {
                showAlert('Lütfen listeye en az bir öğe ekleyin', 'error');
                return;
            }

            try {
                await db.collection(`artifacts/${appId}/public/data/lists`).doc(publicListId).update({
                    name: listName,
                    items: publicListItems, // Items already have imageUrl from Imgur upload
                    updatedAt: firebase.firestore.FieldValue.serverTimestamp()
                });

                showAlert('Liste başarıyla güncellendi!', 'success');
                showPage('publicList');
                loadPublicList(publicListId); // Show the updated list
            } catch (error) {
                showAlert('Genel liste güncellenirken bir hata oluştu: ' + error.message, 'error');
                console.error("Error updating public list: ", error);
            }
        }

        // İletişim Formu İşleyici
        async function handleContactForm(e) {
            e.preventDefault();
            const name = document.getElementById('contact-name').value;
            const email = document.getElementById('contact-email').value;
            const subject = document.getElementById('contact-subject').value;
            const message = document.getElementById('contact-message').value;

            try {
                // Bu verileri normalde bir arka uç sunucusuna gönderirsiniz
                // veya EmailJS, Formspree gibi bir hizmet kullanırsınız.
                // Şimdilik sadece başarıyı simüle edeceğiz.
                console.log('İletişim Formu Verileri:', { name, email, subject, message });

                showAlert('Mesajınız başarıyla gönderildi!', 'success');
                contactForm.reset(); // Formu temizle
            } catch (error) {
                showAlert('Mesaj gönderilirken bir hata oluştu: ' + error.message, 'error');
                console.error("İletişim formu hatası: ", error);
            }
        }
    </script>
</body>
</html>
