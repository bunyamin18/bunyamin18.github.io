<!DOCTYPE html>
<html lang="tr">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Liste Oluştur QR Kod Paylaş</title>
    <link href="https://cdnjs.cloudflare.com/ajax/libs/tailwindcss/2.2.19/tailwind.min.css" rel="stylesheet">
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.0.0-beta3/css/all.min.css">
    <script src="https://cdnjs.cloudflare.com/ajax/libs/qrcodejs/1.0.0/qrcode.min.js"></script>
    <script src="https://unpkg.com/html5-qrcode@2.3.8/html5-qrcode.min.js"></script>
    <style>
        /* Ana renk tanımlamaları */
        .bg-primary {
            background-color: #4f46e5;
        }
        .text-primary {
            color: #4f46e5;
        }
        .border-primary {
            border-color: #4f46e5;
        }
        .hover-bg-primary:hover {
            background-color: #4338ca;
        }
        /* Genel geçişler */
        .transition-all {
            transition: all 0.3s ease;
        }
        /* Gizli öğeler için */
        .hidden {
            display: none;
        }
        /* Maksimum yükseklik sınırlaması */
        .max-h-96 {
            max-height: 24rem;
        }
        /* QR kod tarayıcı video boyutu */
        #qr-video {
            width: 100%;
            max-width: 400px; /* Maksimum genişlik */
            height: auto;
            border-radius: 0.5rem;
        }

        /* QR Kod Tablosu İçin Özel Stiller */
        /* QRCode.js varsayılan olarak bir HTML tablosu oluşturur. Bu stiller, tablonun görünür olmasını sağlar. */
        #qrcode-container table,
        #modal-qrcode-container table {
            border-collapse: collapse; /* Hücreler arasındaki boşluğu kaldırır */
            padding: 0;
            margin: 0;
        }
        #qrcode-container table td,
        #modal-qrcode-container table td {
            width: 2px; /* QR modülleri için küçük hücre boyutu */
            height: 2px;
            padding: 0; /* İç boşluğu kaldırır */
            margin: 0;
        }
        /* Koyu modüller için renk */
        #qrcode-container table td.qrcode-dark,
        #modal-qrcode-container table td.qrcode-dark {
            background-color: #4f46e5; /* Ana renk */
        }
        /* Açık modüller için renk */
        #qrcode-container table td.qrcode-light,
        #modal-qrcode-container table td.qrcode-light {
            background-color: #ffffff; /* Beyaz */
        }
    </style>
</head>
<body class="bg-gray-50 min-h-screen font-sans">
    <header class="bg-white shadow-md">
        <div class="container mx-auto px-4 py-3 flex justify-between items-center">
            <div class="flex items-center space-x-2">
                <i class="fas fa-qrcode text-3xl text-primary"></i>
                <h1 class="text-2xl font-bold text-gray-800">QR Liste</h1>
            </div>
            <nav id="main-nav" class="hidden md:flex space-x-6">
                <a href="#" class="text-gray-600 hover:text-primary transition-all" onclick="showPage('home')">Ana Sayfa</a>
                <a href="#" class="text-gray-600 hover:text-primary transition-all" onclick="showPage('guide')">Kullanım Kılavuzu</a>
                <a href="#" class="text-gray-600 hover:text-primary transition-all" onclick="showPage('contact')">İletişim</a>
                <a href="#" class="text-gray-600 hover:text-primary transition-all auth-hide" onclick="showPage('login')">Giriş Yap</a>
                <a href="#" class="text-gray-600 hover:text-primary transition-all auth-hide" onclick="showPage('register')">Kayıt Ol</a>
                <a href="#" class="text-gray-600 hover:text-primary transition-all auth-show hidden" onclick="showPage('dashboard')">Listelerim</a>
                <a href="#" class="text-gray-600 hover:text-primary transition-all auth-show hidden" onclick="logout()">Çıkış Yap</a>
            </nav>
            <button class="md:hidden text-gray-600" id="mobile-menu-button">
                <i class="fas fa-bars text-2xl"></i>
            </button>
        </div>
        <div class="md:hidden hidden" id="mobile-menu">
            <div class="px-2 pt-2 pb-3 space-y-1 sm:px-3 bg-white shadow-md">
                <a href="#" class="block px-3 py-2 text-gray-600 hover:text-primary transition-all" onclick="showPage('home')">Ana Sayfa</a>
                <a href="#" class="block px-3 py-2 text-gray-600 hover:text-primary transition-all" onclick="showPage('guide')">Kullanım Kılavuzu</a>
                <a href="#" class="block px-3 py-2 text-gray-600 hover:text-primary transition-all" onclick="showPage('contact')">İletişim</a>
                <a href="#" class="block px-3 py-2 text-gray-600 hover:text-primary transition-all auth-hide" onclick="showPage('login')">Giriş Yap</a>
                <a href="#" class="block px-3 py-2 text-gray-600 hover:text-primary transition-all auth-hide" onclick="showPage('register')">Kayıt Ol</a>
                <a href="#" class="block px-3 py-2 text-gray-600 hover:text-primary transition-all auth-show hidden" onclick="showPage('dashboard')">Listelerim</a>
                <a href="#" class="block px-3 py-2 text-gray-600 hover:text-primary transition-all auth-show hidden" onclick="logout()">Çıkış Yap</a>
            </div>
        </div>
    </header>

    <main class="container mx-auto p-4 mt-8">
        <div id="home" class="page">
            <div class="text-center mb-16">
                <h2 class="text-4xl font-bold text-gray-800 mb-4">Liste Oluştur, QR Kod ile Paylaş</h2>
                <p class="text-xl text-gray-600 max-w-2xl mx-auto">
                    İhtiyaç listelerinizi kolayca oluşturun, QR kod ile paylaşın ve güncelleyin.
                </p>
                <div class="mt-10">
                    <button onclick="showPage('login')" class="bg-primary text-white px-8 py-3 rounded-lg shadow-lg hover-bg-primary transition-all auth-hide">
                        Hemen Başla
                    </button>
                    <button onclick="showPage('createList')" class="bg-primary text-white px-8 py-3 rounded-lg shadow-lg hover-bg-primary transition-all auth-show hidden">
                        Liste Oluştur
                    </button>
                </div>
            </div>
            
            <div class="grid md:grid-cols-3 gap-8 mt-12">
                <div class="bg-white p-6 rounded-xl shadow-md">
                    <div class="text-primary text-4xl mb-4">
                        <i class="fas fa-pencil-alt"></i>
                    </div>
                    <h3 class="text-xl font-bold mb-2">Kolay Liste Oluşturma</h3>
                    <p class="text-gray-600">
                        İhtiyaçlarınızı, miktarlarını ve görselleri ekleyerek detaylı listeler oluşturun.
                    </p>
                </div>
                <div class="bg-white p-6 rounded-xl shadow-md">
                    <div class="text-primary text-4xl mb-4">
                        <i class="fas fa-qrcode"></i>
                    </div>
                    <h3 class="text-xl font-bold mb-2">QR Kod Paylaşımı</h3>
                    <p class="text-gray-600">
                        Oluşturduğunuz listeleri QR kod aracılığıyla anında paylaşabilirsiniz.
                    </p>
                </div>
                <div class="bg-white p-6 rounded-xl shadow-md">
                    <div class="text-primary text-4xl mb-4">
                        <i class="fas fa-edit"></i>
                    </div>
                    <h3 class="text-xl font-bold mb-2">Kolay Düzenleme</h3>
                    <p class="text-gray-600">
                        QR kodu okutarak listenizi istediğiniz zaman düzenleyebilirsiniz.
                    </p>
                </div>
            </div>
        </div>

        <div id="login" class="page hidden">
            <div class="max-w-md mx-auto bg-white p-8 rounded-xl shadow-md">
                <h2 class="text-2xl font-bold text-gray-800 mb-6 text-center">Giriş Yap</h2>
                <div id="login-error" class="bg-red-100 text-red-600 p-3 rounded mb-4 hidden"></div>
                <form id="login-form">
                    <div class="mb-4">
                        <label for="login-email" class="block text-gray-700 mb-2">E-posta Adresi</label>
                        <input type="email" id="login-email" class="w-full px-4 py-2 border rounded-lg focus:outline-none focus:ring-2 focus:ring-primary" required>
                    </div>
                    <div class="mb-6">
                        <label for="login-password" class="block text-gray-700 mb-2">Şifre</label>
                        <input type="password" id="login-password" class="w-full px-4 py-2 border rounded-lg focus:outline-none focus:ring-2 focus:ring-primary" required>
                    </div>
                    <button type="submit" class="w-full bg-primary text-white py-2 rounded-lg hover-bg-primary transition-all">
                        Giriş Yap
                    </button>
                </form>
                <div class="mt-4 text-center">
                    <p class="text-gray-600">
                        Hesabınız yok mu? 
                        <a href="#" class="text-primary hover:underline" onclick="showPage('register')">Kayıt Ol</a>
                    </p>
                </div>
            </div>
        </div>

        <div id="register" class="page hidden">
            <div class="max-w-md mx-auto bg-white p-8 rounded-xl shadow-md">
                <h2 class="text-2xl font-bold text-gray-800 mb-6 text-center">Hesap Oluştur</h2>
                <div id="register-error" class="bg-red-100 text-red-600 p-3 rounded mb-4 hidden"></div>
                <form id="register-form">
                    <div class="mb-4">
                        <label for="register-name" class="block text-gray-700 mb-2">Ad Soyad</label>
                        <input type="text" id="register-name" class="w-full px-4 py-2 border rounded-lg focus:outline-none focus:ring-2 focus:ring-primary" required>
                    </div>
                    <div class="mb-4">
                        <label for="register-email" class="block text-gray-700 mb-2">E-posta Adresi</label>
                        <input type="email" id="register-email" class="w-full px-4 py-2 border rounded-lg focus:outline-none focus:ring-2 focus:ring-primary" required>
                    </div>
                    <div class="mb-6">
                        <label for="register-password" class="block text-gray-700 mb-2">Şifre</label>
                        <input type="password" id="register-password" class="w-full px-4 py-2 border rounded-lg focus:outline-none focus:ring-2 focus:ring-primary" required>
                    </div>
                    <button type="submit" class="w-full bg-primary text-white py-2 rounded-lg hover-bg-primary transition-all">
                        Kayıt Ol
                    </button>
                </form>
                <div class="mt-4 text-center">
                    <p class="text-gray-600">
                        Zaten hesabınız var mı? 
                        <a href="#" class="text-primary hover:underline" onclick="showPage('login')">Giriş Yap</a>
                    </p>
                </div>
            </div>
        </div>

        <div id="dashboard" class="page hidden">
            <div class="mb-6 flex justify-between items-center">
                <h2 class="text-3xl font-bold text-gray-800">Listelerim</h2>
                <button onclick="showPage('createList')" class="bg-primary text-white px-4 py-2 rounded-lg shadow hover-bg-primary transition-all flex items-center">
                    <i class="fas fa-plus mr-2"></i> Yeni Liste Oluştur
                </button>
            </div>
            
            <div id="qr-list-counter" class="mb-4 text-gray-600"></div>
            
            <div id="user-lists" class="grid md:grid-cols-2 lg:grid-cols-3 gap-6">
                <div class="text-center text-gray-500 col-span-full py-10" id="no-lists-message">
                    <i class="fas fa-clipboard-list text-5xl mb-4"></i>
                    <p class="text-xl">Henüz liste oluşturmadınız.</p>
                </div>
            </div>
        </div>

        <div id="createList" class="page hidden">
            <div class="max-w-4xl mx-auto">
                <div class="mb-6">
                    <h2 class="text-3xl font-bold text-gray-800">Yeni Liste Oluştur</h2>
                    <p class="text-gray-600 mt-2">Liste adını belirleyin ve öğeler ekleyin.</p>
                </div>
                
                <div class="bg-white p-6 rounded-xl shadow-md mb-8">
                    <h3 class="text-xl font-bold text-gray-800 mb-4">Liste Adı</h3>
                    <div class="mb-4">
                        <label for="list-name" class="block text-gray-700 mb-2">Liste Adı</label>
                        <input type="text" id="list-name" class="w-full px-4 py-2 border rounded-lg focus:outline-none focus:ring-2 focus:ring-primary" placeholder="Alışveriş Listesi" required>
                    </div>
                    
                    <h3 class="text-xl font-bold text-gray-800 mb-4">Yeni Öğe Ekle</h3>
                    
                    <div class="grid md:grid-cols-3 gap-4 mb-4">
                        <div>
                            <label for="item-name" class="block text-gray-700 mb-2">Öğe İsmi</label>
                            <input type="text" id="item-name" class="w-full px-4 py-2 border rounded-lg focus:outline-none focus:ring-2 focus:ring-primary" placeholder="Elma">
                        </div>
                        <div>
                            <label for="item-quantity" class="block text-gray-700 mb-2">Öğe Miktarı</label>
                            <input type="text" id="item-quantity" class="w-full px-4 py-2 border rounded-lg focus:outline-none focus:ring-2 focus:ring-primary" placeholder="2 kg">
                        </div>
                        <div>
                            <label for="item-image" class="block text-gray-700 mb-2">Resim (İsteğe Bağlı)</label>
                            <input type="file" id="item-image" accept="image/*" class="w-full px-4 py-1.5 border rounded-lg focus:outline-none focus:ring-2 focus:ring-primary">
                            <p id="imageError" class="text-red-500 text-xs mt-1"></p>
                        </div>
                    </div>
                    
                    <button id="add-item" class="bg-primary text-white px-4 py-2 rounded-lg shadow hover-bg-primary transition-all">
                        <i class="fas fa-plus mr-2"></i> Öğe Ekle
                    </button>
                </div>
                
                <div class="bg-white p-6 rounded-xl shadow-md mb-8">
                    <h3 class="text-xl font-bold text-gray-800 mb-4">Liste Öğeleri</h3>
                    
                    <div id="item-list" class="max-h-96 overflow-y-auto">
                        </div>
                    <div id="empty-list-message" class="text-center py-8 text-gray-500">
                        <i class="fas fa-clipboard text-4xl mb-3"></i>
                        <p>Henüz öğe eklemediniz.</p>
                    </div>
                </div>
                
                <div class="flex justify-end">
                    <button id="save-list" class="bg-primary text-white px-6 py-3 rounded-lg shadow-lg hover-bg-primary transition-all">
                        <i class="fas fa-save mr-2"></i> Kaydet ve QR Kod Oluştur
                    </button>
                </div>
            </div>
        </div>

        <div id="viewList" class="page hidden">
            <div class="max-w-4xl mx-auto">
                <div class="mb-6 flex items-center">
                    <button onclick="showPage('dashboard')" class="text-gray-600 hover:text-primary mr-4">
                        <i class="fas fa-arrow-left text-lg"></i>
                    </button>
                    <h2 class="text-3xl font-bold text-gray-800" id="view-list-name">Liste Detayları</h2>
                </div>
                
                <div class="grid md:grid-cols-3 gap-6">
                    <div class="md:col-span-2">
                        <div class="bg-white p-6 rounded-xl shadow-md mb-6">
                            <h3 class="text-xl font-bold text-gray-800 mb-4">Liste Öğeleri</h3>
                            
                            <div id="view-item-list" class="max-h-96 overflow-y-auto">
                                </div>
                        </div>
                        
                        <div class="flex justify-end space-x-4">
                            <button id="share-publicly-button" class="bg-green-500 text-white px-6 py-3 rounded-lg shadow-lg hover:bg-green-600 transition-all">
                                <i class="fas fa-share-alt mr-2"></i> Genel Paylaş
                            </button>
                            <button id="edit-list" class="bg-primary text-white px-6 py-3 rounded-lg shadow-lg hover-bg-primary transition-all">
                                <i class="fas fa-edit mr-2"></i> Listeyi Düzenle
                            </button>
                        </div>
                    </div>
                    
                    <div>
                        <div class="bg-white p-6 rounded-xl shadow-md">
                            <h3 class="text-xl font-bold text-gray-800 mb-4">QR Kod</h3>
                            <div id="qrcode-container" class="flex justify-center mb-4"></div>
                            <button id="download-qr" class="w-full bg-gray-200 text-gray-800 px-4 py-2 rounded-lg hover:bg-gray-300 transition-all flex items-center justify-center">
                                <i class="fas fa-download mr-2"></i> QR Kodu İndir
                            </button>
                        </div>
                    </div>
                </div>
            </div>
        </div>

        <div id="editList" class="page hidden">
            <div class="max-w-4xl mx-auto">
                <div class="mb-6">
                    <h2 class="text-3xl font-bold text-gray-800">Listeyi Düzenle</h2>
                    <p class="text-gray-600 mt-2" id="edit-list-id"></p>
                </div>
                
                <div class="bg-white p-6 rounded-xl shadow-md mb-8">
                    <div class="mb-6">
                        <label for="edit-list-name" class="block text-gray-700 mb-2 font-medium">Liste Adı</label>
                        <input type="text" id="edit-list-name" class="w-full px-4 py-2 border rounded-lg focus:outline-none focus:ring-2 focus:ring-primary" required>
                    </div>
                </div>
                
                <div class="bg-white p-6 rounded-xl shadow-md mb-8">
                    <h3 class="text-xl font-bold text-gray-800 mb-4">Yeni Öğe Ekle</h3>
                    
                    <div class="grid md:grid-cols-3 gap-4 mb-4">
                        <div>
                            <label for="edit-item-name" class="block text-gray-700 mb-2">Öğe İsmi</label>
                            <input type="text" id="edit-item-name" class="w-full px-4 py-2 border rounded-lg focus:outline-none focus:ring-2 focus:ring-primary" placeholder="Elma">
                        </div>
                        <div>
                            <label for="edit-item-quantity" class="block text-gray-700 mb-2">Öğe Miktarı</label>
                            <input type="text" id="edit-item-quantity" class="w-full px-4 py-2 border rounded-lg focus:outline-none focus:ring-2 focus:ring-primary" placeholder="2 kg">
                        </div>
                        <div>
                            <label for="edit-item-image" class="block text-gray-700 mb-2">Resim (İsteğe Bağlı)</label>
                            <input type="file" id="edit-item-image" accept="image/*" class="w-full px-4 py-1.5 border rounded-lg focus:outline-none focus:ring-2 focus:ring-primary">
                            <p id="editImageError" class="text-red-500 text-xs mt-1"></p>
                        </div>
                    </div>
                    
                    <button id="edit-add-item" class="bg-primary text-white px-4 py-2 rounded-lg shadow hover-bg-primary transition-all">
                        <i class="fas fa-plus mr-2"></i> Öğe Ekle
                    </button>
                </div>
                
                <div class="bg-white p-6 rounded-xl shadow-md mb-8">
                    <h3 class="text-xl font-bold text-gray-800 mb-4">Liste Öğeleri</h3>
                    
                    <div id="edit-item-list" class="max-h-96 overflow-y-auto">
                        </div>
                </div>
                
                <div class="flex justify-between">
                    <button onclick="cancelEdit()" class="bg-gray-200 text-gray-800 px-6 py-3 rounded-lg shadow-lg hover:bg-gray-300 transition-all">
                        <i class="fas fa-times mr-2"></i> İptal
                    </button>
                    <button id="update-list" class="bg-primary text-white px-6 py-3 rounded-lg shadow-lg hover-bg-primary transition-all">
                        <i class="fas fa-save mr-2"></i> Değişiklikleri Kaydet
                    </button>
                </div>
            </div>
        </div>

        <div id="publicList" class="page hidden">
            <div class="max-w-4xl mx-auto">
                <div class="mb-6">
                    <h2 class="text-3xl font-bold text-gray-800" id="public-list-name">Liste</h2>
                    <p class="text-gray-600 mt-2" id="public-list-id"></p>
                </div>
                
                <div class="bg-white p-6 rounded-xl shadow-md mb-8">
                    <h3 class="text-xl font-bold text-gray-800 mb-4">Liste Öğeleri</h3>
                    
                    <div id="public-item-list" class="max-h-96 overflow-y-auto">
                        </div>
                </div>
                
                <div class="flex justify-end">
                    <button id="edit-public-list" class="bg-primary text-white px-6 py-3 rounded-lg shadow-lg hover-bg-primary transition-all">
                        <i class="fas fa-edit mr-2"></i> Listeyi Düzenle
                    </button>
                </div>
            </div>
        </div>

        <div id="editPublicList" class="page hidden">
            <div class="max-w-4xl mx-auto">
                <div class="mb-6">
                    <h2 class="text-3xl font-bold text-gray-800">Listeyi Düzenle</h2>
                    <p class="text-gray-600 mt-2" id="edit-public-list-id"></p>
                </div>
                
                <div class="bg-white p-6 rounded-xl shadow-md mb-8">
                    <div class="mb-6">
                        <label for="edit-public-list-name" class="block text-gray-700 mb-2 font-medium">Liste Adı</label>
                        <input type="text" id="edit-public-list-name" class="w-full px-4 py-2 border rounded-lg focus:outline-none focus:ring-2 focus:ring-primary" required>
                    </div>
                </div>
                
                <div class="bg-white p-6 rounded-xl shadow-md mb-8">
                    <h3 class="text-xl font-bold text-gray-800 mb-4">Yeni Öğe Ekle</h3>
                    
                    <div class="grid md:grid-cols-3 gap-4 mb-4">
                        <div>
                            <label for="edit-public-item-name" class="block text-gray-700 mb-2">Öğe İsmi</label>
                            <input type="text" id="edit-public-item-name" class="w-full px-4 py-2 border rounded-lg focus:outline-none focus:ring-2 focus:ring-primary" placeholder="Elma">
                        </div>
                        <div>
                            <label for="edit-public-item-quantity" class="block text-gray-700 mb-2">Öğe Miktarı</label>
                            <input type="text" id="edit-public-item-quantity" class="w-full px-4 py-2 border rounded-lg focus:outline-none focus:ring-2 focus:ring-primary" placeholder="2 kg">
                        </div>
                        <div>
                            <label for="edit-public-item-image" class="block text-gray-700 mb-2">Resim (İsteğe Bağlı)</label>
                            <input type="file" id="edit-public-item-image" accept="image/*" class="w-full px-4 py-1.5 border rounded-lg focus:outline-none focus:ring-2 focus:ring-primary">
                            <p id="editPublicImageError" class="text-red-500 text-xs mt-1"></p>
                        </div>
                    </div>
                    
                    <button id="edit-public-add-item" class="bg-primary text-white px-4 py-2 rounded-lg shadow hover-bg-primary transition-all">
                        <i class="fas fa-plus mr-2"></i> Öğe Ekle
                    </button>
                </div>
                
                <div class="bg-white p-6 rounded-xl shadow-md mb-8">
                    <h3 class="text-xl font-bold text-gray-800 mb-4">Liste Öğeleri</h3>
                    
                    <div id="edit-public-item-list" class="max-h-96 overflow-y-auto">
                        </div>
                </div>
                
                <div class="flex justify-between">
                    <button onclick="cancelPublicEdit()" class="bg-gray-200 text-gray-800 px-6 py-3 rounded-lg shadow-lg hover:bg-gray-300 transition-all">
                        <i class="fas fa-times mr-2"></i> İptal
                    </button>
                    <button id="update-public-list" class="bg-primary text-white px-6 py-3 rounded-lg shadow-lg hover-bg-primary transition-all">
                        <i class="fas fa-save mr-2"></i> Değişiklikleri Kaydet
                    </button>
                </div>
            </div>
        </div>

        <div id="qrScanner" class="page hidden">
            <div class="max-w-md mx-auto bg-white p-8 rounded-xl shadow-md">
                <h2 class="text-2xl font-bold text-gray-800 mb-6 text-center">QR Kod Tara</h2>
                <div class="text-center mb-4">
                    <input type="text" id="list-id-input" class="w-full px-4 py-2 border rounded-lg focus:outline-none focus:ring-2 focus:ring-primary" placeholder="Liste ID girin">
                </div>
                <button id="scan-qr-button" class="w-full bg-primary text-white py-2 rounded-lg hover-bg-primary transition-all mb-4">
                    <i class="fas fa-qrcode mr-2"></i> QR Kod Tara
                </button>
                <div id="qr-scanner-container" class="hidden mb-4 flex justify-center">
                    <video id="qr-video" class="w-full rounded-lg"></video>
                </div>
                <button id="view-list-button" class="w-full bg-primary text-white py-2 rounded-lg hover-bg-primary transition-all">
                    <i class="fas fa-eye mr-2"></i> Listeyi Görüntüle
                </button>
            </div>
        </div>

        <div id="guide" class="page hidden">
            <div class="max-w-3xl mx-auto">
                <h2 class="text-3xl font-bold text-gray-800 mb-6">Kullanım Kılavuzu</h2>
                
                <div class="bg-white p-6 rounded-xl shadow-md mb-8">
                    <h3 class="text-xl font-bold text-gray-800 mb-4">Hesap Oluşturma ve Giriş</h3>
                    <ol class="list-decimal pl-5 space-y-3 text-gray-700">
                        <li>Sağ üst köşedeki "Kayıt Ol" butonuna tıklayın.</li>
                        <li>Ad, e-posta ve şifre bilgilerinizi girin.</li>
                        <li>Hesabınızı oluşturduktan sonra, e-posta ve şifrenizle giriş yapabilirsiniz.</li>
                        <li>Her hesap en fazla 4 adet liste oluşturabilir.</li>
                    </ol>
                </div>
                
                <div class="bg-white p-6 rounded-xl shadow-md mb-8">
                    <h3 class="text-xl font-bold text-gray-800 mb-4">Liste Oluşturma</h3>
                    <ol class="list-decimal pl-5 space-y-3 text-gray-700">
                        <li>"Liste Oluştur" butonuna tıklayın.</li>
                        <li>Listenize bir isim verin.</li>
                        <li>Öğe ekleme formunda öğe adı, miktarı ve isterseniz bir resim ekleyin.</li>
                        <li>"Öğe Ekle" butonuna tıklayarak listeye ekleyin.</li>
                        <li>Tüm öğeleri ekledikten sonra "Kaydet ve QR Kod Oluştur" butonuna tıklayın.</li>
                    </ol>
                </div>
                
                <div class="bg-white p-6 rounded-xl shadow-md mb-8">
                    <h3 class="text-xl font-bold text-gray-800 mb-4">QR Kod Paylaşımı</h3>
                    <ol class="list-decimal pl-5 space-y-3 text-gray-700">
                        <li>Liste oluşturulduktan sonra otomatik olarak bir QR kod oluşturulacaktır.</li>
                        <li>"QR Kodu İndir" butonuna tıklayarak kodu kaydedebilirsiniz.</li>
                        <li>QR kodu başkalarıyla paylaşabilirsiniz.</li>
                        <li>QR kodu taratarak listeye erişebilir ve gerekirse düzenleyebilirsiniz.</li>
                    </ol>
                </div>
                
                <div class="bg-white p-6 rounded-xl shadow-md">
                    <h3 class="text-xl font-bold text-gray-800 mb-4">Liste Düzenleme</h3>
                    <ol class="list-decimal pl-5 space-y-3 text-gray-700">
                        <li>Listenizi görüntülerken "Listeyi Düzenle" butonuna tıklayın.</li>
                        <li>Liste adını veya öğeleri değiştirebilir, yeni öğeler ekleyebilir veya mevcut öğeleri silebilirsiniz.</li>
                        <li>Değişiklikleri tamamladıktan sonra "Değişiklikleri Kaydet" butonuna tıklayın.</li>
                        <li>Değişiklikler aynı QR kod üzerinden erişilebilir olacaktır.</li>
                    </ol>
                </div>
            </div>
        </div>

        <div id="contact" class="page hidden">
            <div class="max-w-3xl mx-auto">
                <h2 class="text-3xl font-bold text-gray-800 mb-6">İletişim</h2>
                
                <div class="bg-white p-6 rounded-xl shadow-md mb-8">
                    <div class="flex items-start mb-6">
                        <div class="text-primary text-2xl mr-4">
                            <i class="fas fa-envelope"></i>
                        </div>
                        <div>
                            <h3 class="text-xl font-bold text-gray-800 mb-1">E-posta</h3>
                            <p class="text-gray-700">ebunyamin0@gmail.com</p>
                        </div>
                    </div>
                    
                    <form id="contact-form">
                        <div class="mb-4">
                            <label for="contact-name" class="block text-gray-700 mb-2">Adınız Soyadınız</label>
                            <input type="text" id="contact-name" class="w-full px-4 py-2 border rounded-lg focus:outline-none focus:ring-2 focus:ring-primary" required>
                        </div>
                        <div class="mb-4">
                            <label for="contact-email" class="block text-gray-700 mb-2">E-posta Adresiniz</label>
                            <input type="email" id="contact-email" class="w-full px-4 py-2 border rounded-lg focus:outline-none focus:ring-2 focus:ring-primary" required>
                        </div>
                        <div class="mb-4">
                            <label for="contact-subject" class="block text-gray-700 mb-2">Konu</label>
                            <input type="text" id="contact-subject" class="w-full px-4 py-2 border rounded-lg focus:outline-none focus:ring-2 focus:ring-primary" required>
                        </div>
                        <div class="mb-6">
                            <label for="contact-message" class="block text-gray-700 mb-2">Mesajınız</label>
                            <textarea id="contact-message" rows="5" class="w-full px-4 py-2 border rounded-lg focus:outline-none focus:ring-2 focus:ring-primary" required></textarea>
                        </div>
                        <button type="submit" class="w-full bg-primary text-white py-2 rounded-lg hover-bg-primary transition-all">
                            Mesaj Gönder
                        </button>
                    </form>
            </div>
        </div>
    </main>

    <footer class="bg-gray-800 text-white py-10 mt-16">
        <div class="container mx-auto px-4">
            <div class="grid md:grid-cols-3 gap-8">
                <div>
                    <div class="flex items-center space-x-2 mb-4">
                        <i class="fas fa-qrcode text-2xl text-white"></i>
                        <h3 class="text-xl font-bold">QR Liste</h3>
                    </div>
                    <p class="text-gray-400">
                        İhtiyaçlarınızı organize etmenin en kolay yolu. Liste oluşturun, QR kod ile paylaşın, düzenleyin.
                    </p>
                </div>
                
                <div>
                    <h3 class="text-lg font-bold mb-4">Hızlı Bağlantılar</h3>
                    <ul class="space-y-2 text-gray-400">
                        <li><a href="#" class="hover:text-white transition-all" onclick="showPage('home')">Ana Sayfa</a></li>
                        <li><a href="#" class="hover:text-white transition-all" onclick="showPage('guide')">Kullanım Kılavuzu</a></li>
                        <li><a href="#" class="hover:text-white transition-all" onclick="showPage('contact')">İletişim</a></li>
                        <li><a href="#" class="hover:text-white transition-all auth-hide" onclick="showPage('login')">Giriş Yap</a></li>
                        <li><a href="#" class="hover:text-white transition-all auth-hide" onclick="showPage('register')">Kayıt Ol</a></li>
                    </ul>
                </div>
                
                <div>
                    <h3 class="text-lg font-bold mb-4">İletişim</h3>
                    <ul class="space-y-2 text-gray-400">
                        <li class="flex items-start">
                            <i class="fas fa-envelope mt-1 mr-2"></i>
                            <span>ebunyamin0@gmail.com</span>
                        </li>
                    </ul>
                </div>
            </div>
            
            <div class="border-t border-gray-700 mt-8 pt-8 text-center text-gray-400">
                <p>&copy; 2025 Bünyamin Ekmekcioğlu</p>
            </div>
        </div>
    </footer>

    <div id="qr-modal" class="fixed inset-0 bg-black bg-opacity-50 flex items-center justify-center z-50 hidden">
        <div class="bg-white p-6 rounded-xl shadow-lg max-w-md w-full">
            <div class="flex justify-between items-center mb-4">
                <h3 class="text-xl font-bold text-gray-800">QR Kod</h3>
                <button id="close-qr-modal" class="text-gray-500 hover:text-gray-800">
                    <i class="fas fa-times text-xl"></i>
                </button>
            </div>
            <div id="modal-qrcode-container" class="flex justify-center mb-6"></div>
            <div class="text-center text-gray-700 mb-6">
                <p class="mb-2">Bu QR kodu tarayarak listeye erişebilirsiniz.</p>
                <p id="qr-list-id" class="font-mono bg-gray-100 p-2 rounded"></p>
            </div>
            <div class="flex space-x-2">
                <button id="modal-download-qr" class="flex-1 bg-primary text-white py-2 rounded-lg hover-bg-primary transition-all">
                    <i class="fas fa-download mr-2"></i> QR Kodu İndir
                </button>
                <button id="copy-list-id" class="flex-1 bg-gray-200 text-gray-800 py-2 rounded-lg hover:bg-gray-300 transition-all">
                    <i class="fas fa-copy mr-2"></i> ID Kopyala
                </button>
            </div>
        </div>
    </div>

    <div id="alert" class="fixed bottom-4 right-4 max-w-xs bg-white rounded-lg shadow-lg overflow-hidden transform transition-all duration-300 translate-y-20 opacity-0">
        <div class="p-4">
            <div class="flex items-start">
                <div id="alert-icon" class="flex-shrink-0">
                    <i class="fas fa-check-circle text-green-500 text-xl"></i>
                </div>
                <div class="ml-3 w-0 flex-1">
                    <p id="alert-message" class="text-sm font-medium text-gray-800">
                        İşlem başarıyla tamamlandı.
                    </p>
                </div>
                <div class="ml-4 flex-shrink-0 flex">
                    <button id="close-alert" class="inline-flex text-gray-400 hover:text-gray-500">
                        <i class="fas fa-times"></i>
                    </button>
                </div>
            </div>
        </div>
        <div id="alert-progress" class="h-1 bg-green-500"></div>
    </div>

    <script type="module">
        // Firebase SDK'ları
        import { initializeApp } from "https://www.gstatic.com/firebasejs/9.6.1/firebase-app.js";
        import { getAuth, signInAnonymously, signInWithCustomToken, onAuthStateChanged, signOut, createUserWithEmailAndPassword, signInWithEmailAndPassword } from "https://www.gstatic.com/firebasejs/9.6.1/firebase-auth.js";
        import { getFirestore, doc, getDoc, addDoc, setDoc, updateDoc, deleteDoc, collection, query, where, getDocs, serverTimestamp, FieldValue } from "https://www.gstatic.com/firebasejs/9.6.1/firebase-firestore.js";
        import { getStorage, ref, uploadBytes, getDownloadURL, deleteObject } from "https://www.gstatic.com/firebasejs/9.6.1/firebase-storage.js";

        // Firebase Configuration - Kullanıcının sağladığı yapılandırma bilgileri
        const firebaseConfig = { 
            apiKey: "AIzaSyCGG5Ur3YpVxbtkjooMxE6r7RPuAmZoFRI", 
            authDomain: "anonim-not.firebaseapp.com", 
            projectId: "anonim-not", 
            storageBucket: "anonim-not.appspot.com", 
            messagingSenderId: "1020793266706", 
            appId: "1:1020793266706:web:bdaba147c8367a50dfaecb" 
        };
        const appId = firebaseConfig.projectId; // projectId'yi appId olarak kullanıyoruz

        // Initialize Firebase
        const app = initializeApp(firebaseConfig);
        const auth = getAuth(app);
        const db = getFirestore(app);
        const storage = getStorage(app);
        
        // Global Variables
        let currentUser = null;
        let userId = null;
        let currentListId = null;
        let currentListItems = JSON.parse(localStorage.getItem('draftItems')) || [];
        let editingListId = null;
        let editingListItems = [];
        let publicListId = null;
        let publicListItems = [];
        let qrScanner = null;
        let alertTimeout; // Variable for alert timeout

        // Imgur Client ID (replace with your actual client ID)
        const IMGUR_CLIENT_ID = "895f27f2c7a23be"; // Your Imgur Client ID

        // DOM Elements (initially null, assigned after DOMContentLoaded)
        let mobileMenuButton, mainNav, loginForm, registerForm, addItemButton, saveListButton, editListButton, updateListButton, qrModal, closeQrModalButton, modalDownloadQrButton, copyListIdButton, downloadQrButton, editPublicListButton, updatePublicListButton, editPublicAddItemButton, scanQrButton, viewListButtonElem, contactForm, alertElement, alertIcon, alertMessage, alertProgress, closeAlertButton, editAddItemElem, sharePubliclyButton;


        // --- Core Functions ---

        // Show Page
        function showPage(pageId) {
            console.log(`Attempting to show page: ${pageId}`);
            const pages = document.querySelectorAll('.page');
            pages.forEach(page => {
                if (page.id === pageId) {
                    page.classList.remove('hidden');
                    console.log(`Page ${pageId} shown.`);
                } else {
                    page.classList.add('hidden');
                }
            });
            
            const mobileMenu = document.getElementById('mobile-menu');
            if (mobileMenu && !mobileMenu.classList.contains('hidden')) {
                mobileMenu.classList.add('hidden');
                console.log("Mobile menu hidden.");
            }
            
            window.scrollTo(0, 0);

            if (pageId === 'dashboard' && currentUser) {
                loadUserLists();
                console.log("Loading user lists for dashboard.");
            } else if (pageId === 'createList') {
                currentListItems = JSON.parse(localStorage.getItem('draftItems')) || [];
                renderCurrentListItems();
                const listNameInput = document.getElementById('list-name');
                if (listNameInput) listNameInput.value = '';
                const itemNameInput = document.getElementById('item-name');
                if (itemNameInput) itemNameInput.value = '';
                const itemQuantityInput = document.getElementById('item-quantity');
                if (itemQuantityInput) itemQuantityInput.value = '';
                const itemImageInput = document.getElementById('item-image');
                if (itemImageInput) itemImageInput.value = '';
                const imageErrorElement = document.getElementById('imageError');
                if (imageErrorElement) imageErrorElement.textContent = '';
                console.log("Resetting createList form and rendering draft items.");
            }
        }
        // showPage fonksiyonunu global erişilebilir yap
        window.showPage = showPage;
        
        // Toggle Mobile Menu
        function toggleMobileMenu() {
            console.log("toggleMobileMenu called.");
            const mobileMenu = document.getElementById('mobile-menu');
            mobileMenu.classList.toggle('hidden');
            console.log("Mobile menu hidden status:", mobileMenu.classList.contains('hidden'));
        }
        // toggleMobileMenu fonksiyonunu global erişilebilir yap
        window.toggleMobileMenu = toggleMobileMenu;

        // Logout Handler
        async function logout() {
            try {
                await signOut(auth);
                showAlert('Çıkış yapıldı!', 'success');
                showPage('home');
            } catch (error) {
                showAlert('Çıkış yaparken bir hata oluştu: ' + error.message, 'error');
            }
        }
        // logout fonksiyonunu global erişilebilir yap
        window.logout = logout;

        // List Deletion Confirmation
        function confirmDeleteList(listId) {
            const confirmModal = createConfirmModal('Bu listeyi silmek istediğinizden emin misiniz? Bu işlem geri alınamaz.', () => {
                deleteList(listId);
                document.body.removeChild(confirmModal);
            }, () => {
                document.body.removeChild(confirmModal);
            });
            document.body.appendChild(confirmModal);
        }
        // confirmDeleteList fonksiyonunu global erişilebilir yap
        window.confirmDeleteList = confirmDeleteList;

        // Custom Confirmation Modal
        function createConfirmModal(message, onConfirm, onCancel) {
            const modal = document.createElement('div');
            modal.className = 'fixed inset-0 bg-black bg-opacity-50 flex items-center justify-center z-50';
            modal.innerHTML = `
                <div class="bg-white p-6 rounded-xl shadow-lg max-w-sm w-full">
                    <h3 class="text-xl font-bold text-gray-800 mb-4">Onay</h3>
                    <p class="text-gray-700 mb-6">${message}</p>
                    <div class="flex justify-end space-x-4">
                        <button class="bg-gray-200 text-gray-800 px-4 py-2 rounded-lg hover:bg-gray-300 transition-all" id="confirm-cancel">İptal</button>
                        <button class="bg-red-500 text-white px-4 py-2 rounded-lg hover:bg-red-600 transition-all" id="confirm-ok">Sil</button>
                    </div>
                </div>
            `;
            modal.querySelector('#confirm-ok').addEventListener('click', onConfirm);
            modal.querySelector('#confirm-cancel').addEventListener('click', onCancel);
            return modal;
        }

        // Cancel Edit
        function cancelEdit() {
            editingListId = null;
            editingListItems = [];
            showPage('viewList');
            displayListDetails(currentListId);
        }
        // cancelEdit fonksiyonunu global erişilebilir yap
        window.cancelEdit = cancelEdit;

        // Cancel Public Edit
        function cancelPublicEdit() {
            showPage('publicList');
            loadPublicList(publicListId);
        }
        // cancelPublicEdit fonksiyonunu global erişilebilir yap
        window.cancelPublicEdit = cancelPublicEdit;

        // View List by ID from scanner input
        function viewListById() {
            const listId = document.getElementById('list-id-input').value.trim();
            if (listId) {
                loadPublicList(listId);
            } else {
                showAlert('Lütfen bir Liste ID girin veya QR kod tarayın.', 'error');
            }
        }
        // viewListById fonksiyonunu global erişilebilir yap
        window.viewListById = viewListById;

        // QR Scanner
        function initQrScanner() {
            showPage('qrScanner');
            const qrVideo = document.getElementById('qr-video');
            const qrScannerContainer = document.getElementById('qr-scanner-container');

            if (qrScanner) {
                qrScanner.destroy();
            }

            qrScannerContainer.classList.remove('hidden');

            Html5Qrcode.getCameras().then(devices => {
                if (devices && devices.length) {
                    const cameraId = devices[0].id;
                    qrScanner = new Html5Qrcode("qr-video");
                    qrScanner.start(
                            cameraId, {
                                fps: 10,
                                qrbox: {
                                    width: 250,
                                    height: 250
                                }
                            },
                            (decodedText, decodedResult) => {
                                if (decodedText) {
                                    qrScanner.stop();
                                    let extractedListId = decodedText;
                                    try {
                                        const url = new URL(decodedText);
                                        const listParam = url.searchParams.get('list');
                                        if (listParam) {
                                            extractedListId = listParam;
                                        }
                                    } catch (e) {
                                        // decodedText bir URL değilse, doğrudan ID olarak kullanmaya devam et
                                    }

                                    document.getElementById('list-id-input').value = extractedListId; 
                                    showAlert('QR kod tarandı!', 'success');
                                    qrScannerContainer.classList.add('hidden');
                                }
                            },
                            (errorMessage) => {
                                // console.log(`QR Scan Error: ${errorMessage}`);
                            })
                        .catch((err) => {
                            showAlert('Kamera başlatılırken hata oluştu: ' + err, 'error');
                            console.error("Error starting QR scanner:", err);
                        });
                } else {
                    showAlert('Kamera bulunamadı.', 'error');
                    qrScannerContainer.classList.add('hidden');
                }
            }).catch(err => {
                showAlert('Kamera erişim hatası: ' + err, 'error');
                qrScannerContainer.classList.add('hidden');
            });
        }

        // Show loading indicator (for image uploads)
        function showLoading() {
            console.log("Loading...");
        }

        // Hide loading indicator
        function hideLoading() {
            console.log("Loading finished.");
        }

        // Test Imgur connection
        async function checkImgurStatus() {
            try {
                const response = await fetch("https://api.imgur.com/3/credits", {
                    headers: { "Authorization": `Client-ID ${IMGUR_CLIENT_ID}` }
                });
                const data = await response.json();
                console.log("Imgur API Status:", data);
                if (!data.success) {
                    console.warn("Imgur API Limits:", data.data);
                }
            } catch (error) {
                console.error("Imgur Connection Error:", error);
            }
        }

        // Upload image to Imgur
        async function uploadImageToImgur(file, errorElementId) {
            showLoading();
            const errorElement = document.getElementById(errorElementId);
            if (errorElement) errorElement.textContent = "";

            if (file.size > 10 * 1024 * 1024) {
                hideLoading();
                if (errorElement) errorElement.textContent = "Resim boyutu 10MB'tan küçük olmalı!";
                showAlert("Resim boyutu 10MB'tan küçük olmalı!", "error");
                throw new Error("File size exceeded");
            }

            const formData = new FormData();
            formData.append("image", file);

            try {
                const response = await fetch("https://api.imgur.com/3/image", {
                    method: "POST",
                    headers: {
                        "Authorization": `Client-ID ${IMGUR_CLIENT_ID}`
                    },
                    body: formData
                });

                const data = await response.json();
                if (!data.success) {
                    throw new Error(data.data.error || "Imgur upload error");
                }
                return data.data.link;
            } catch (error) {
                console.error("Imgur Error:", {
                    error: error.message,
                    stack: error.stack
                });
                if (errorElement) errorElement.textContent = "Resim yüklenemedi: " + error.message;
                showAlert("Resim yüklenemedi: " + error.message, "error");
                throw error;
            } finally {
                hideLoading();
            }
        }

        // Initialize the Application
        async function initApp() {
            console.log("initApp called.");

            // Assign DOM elements after DOMContentLoaded
            mobileMenuButton = document.getElementById('mobile-menu-button');
            mainNav = document.getElementById('main-nav');
            loginForm = document.getElementById('login-form');
            registerForm = document.getElementById('register-form');
            addItemButton = document.getElementById('add-item');
            saveListButton = document.getElementById('save-list');
            editListButton = document.getElementById('edit-list');
            updateListButton = document.getElementById('update-list');
            qrModal = document.getElementById('qr-modal');
            closeQrModalButton = document.getElementById('close-qr-modal');
            modalDownloadQrButton = document.getElementById('modal-download-qr');
            copyListIdButton = document.getElementById('copy-list-id');
            downloadQrButton = document.getElementById('download-qr');
            editPublicListButton = document.getElementById('edit-public-list');
            updatePublicListButton = document.getElementById('update-public-list');
            editPublicAddItemButton = document.getElementById('edit-public-add-item');
            scanQrButton = document.getElementById('scan-qr-button');
            viewListButtonElem = document.getElementById('view-list-button');
            contactForm = document.getElementById('contact-form');
            alertElement = document.getElementById('alert');
            alertIcon = document.getElementById('alert-icon');
            alertMessage = document.getElementById('alert-message');
            alertProgress = document.getElementById('alert-progress');
            closeAlertButton = document.getElementById('close-alert');
            editAddItemElem = document.getElementById('edit-add-item');
            sharePubliclyButton = document.getElementById('share-publicly-button'); // Yeni buton

            // Add Event Listeners
            if (mobileMenuButton) mobileMenuButton.addEventListener('click', toggleMobileMenu);
            if (loginForm) loginForm.addEventListener('submit', handleLogin);
            if (registerForm) registerForm.addEventListener('submit', handleRegister);
            if (addItemButton) addItemButton.addEventListener('click', addItemToList);
            if (saveListButton) saveListButton.addEventListener('click', saveList);
            if (editListButton) editListButton.addEventListener('click', editList);
            if (updateListButton) updateListButton.addEventListener('click', updateList);
            if (closeQrModalButton) closeQrModalButton.addEventListener('click', closeQrModal);
            if (modalDownloadQrButton) modalDownloadQrButton.addEventListener('click', downloadQrCode);
            if (copyListIdButton) copyListIdButton.addEventListener('click', copyListId);
            if (downloadQrButton) downloadQrButton.addEventListener('click', downloadQrCode);
            if (editPublicListButton) editPublicListButton.addEventListener('click', editPublicList);
            if (updatePublicListButton) updatePublicListButton.addEventListener('click', updatePublicList);
            if (editPublicAddItemButton) editPublicAddItemButton.addEventListener('click', addItemToPublicList);
            if (scanQrButton) scanQrButton.addEventListener('click', initQrScanner);
            if (viewListButtonElem) viewListButtonElem.addEventListener('click', viewListById);
            if (editAddItemElem) editAddItemElem.addEventListener('click', addItemToEditList);
            if (contactForm) contactForm.addEventListener('submit', handleContactForm);
            if (closeAlertButton) closeAlertButton.addEventListener('click', hideAlert);
            if (sharePubliclyButton) sharePubliclyButton.addEventListener('click', () => shareListPublicly(currentListId)); // Yeni buton event listener

            try {
                // Kullanıcının sağladığı özel Firebase yapılandırmasını kullanıyoruz.
                // Bu nedenle Canvas'ın __initial_auth_token'ını kullanmıyoruz.
                await signInAnonymously(auth);
                console.log("Firebase kimlik doğrulama başarılı (anonim).");

            } catch (error) {
                console.error("initApp sırasında genel Firebase kimlik doğrulama hatası:", error);
                showAlert("Firebase kimlik doğrulama hatası: " + error.message, 'error');
            }

            onAuthStateChanged(auth, user => {
                console.log("onAuthStateChanged tetiklendi. Kullanıcı:", user ? user.uid : "boş (oturum açılmamış)");
                currentUser = user;
                userId = user ? user.uid : crypto.randomUUID();
                console.log("Mevcut userId:", userId);
                updateAuthUI();
                
                if (user) {
                    console.log("Kullanıcı oturum açmış, kullanıcı listeleri yükleniyor.");
                    loadUserLists();
                }
                
                const urlParams = new URLSearchParams(window.location.search);
                const listId = urlParams.get('list');
                
                if (listId) {
                    console.log(`URL'de liste kimliği bulundu: ${listId}. Genel liste yükleniyor.`);
                    loadPublicList(listId);
                } else {
                    console.log("URL'de liste kimliği yok. Ana sayfa gösteriliyor.");
                    showPage('home');
                }
            });

            checkImgurStatus();
            renderCurrentListItems();
        }
        
        // Update UI based on Authentication Status
        function updateAuthUI() {
            console.log("updateAuthUI called. currentUser:", currentUser ? currentUser.uid : "null (not logged in)");
            
            const authHideElements = document.querySelectorAll('.auth-hide');
            const authShowElements = document.querySelectorAll('.auth-show');
            
            if (currentUser) {
                console.log("User is logged in. Hiding auth-hide elements, showing auth-show elements.");
                
                if (mainNav) {
                    mainNav.classList.remove('hidden');
                    mainNav.classList.add('md:flex');
                }

                authHideElements.forEach(el => {
                    el.classList.add('hidden');
                    console.log(`Element with class auth-hide hidden: ${el.tagName} ${el.textContent.trim().substring(0, 20)}...`);
                });
                authShowElements.forEach(el => {
                    el.classList.remove('hidden');
                    console.log(`Element with class auth-show shown: ${el.tagName} ${el.textContent.trim().substring(0, 20)}...`);
                });
            } else {
                console.log("User is NOT logged in. Showing auth-hide elements, hiding auth-show elements.");
                
                if (mainNav) {
                    mainNav.classList.add('hidden');
                    mainNav.classList.remove('md:flex');
                }

                authHideElements.forEach(el => {
                    el.classList.remove('hidden');
                    console.log(`Element with class auth-hide shown: ${el.tagName} ${el.textContent.trim().substring(0, 20)}...`);
                });
                authShowElements.forEach(el => {
                    el.classList.add('hidden');
                    console.log(`Element with class auth-show hidden: ${el.tagName} ${el.textContent.trim().substring(0, 20)}...`);
                });
            }
        }
        
        // Show Alert Message
        function showAlert(message, type = 'success') {
            clearTimeout(alertTimeout);

            alertMessage.textContent = message;
            if (type === 'success') {
                alertIcon.innerHTML = '<i class="fas fa-check-circle text-green-500 text-xl"></i>';
                alertProgress.classList.remove('bg-red-500');
                alertProgress.classList.add('bg-green-500');
            } else {
                alertIcon.innerHTML = '<i class="fas fa-times-circle text-red-500 text-xl"></i>';
                alertProgress.classList.remove('bg-green-500');
                alertProgress.classList.add('bg-red-500');
            }

            alertElement.classList.remove('translate-y-20', 'opacity-0');
            alertElement.classList.add('translate-y-0', 'opacity-100');

            alertProgress.style.width = '100%';
            alertProgress.style.transition = 'width 4s linear';

            alertTimeout = setTimeout(() => {
                hideAlert();
            }, 4000);
        }

        // Hide Alert Message
        function hideAlert() {
            alertElement.classList.remove('translate-y-0', 'opacity-100');
            alertElement.classList.add('translate-y-20', 'opacity-0');
            alertProgress.style.transition = 'none';
            alertProgress.style.width = '0%';
        }

        // User Authentication Operations

        // Login Handler
        async function handleLogin(e) {
            e.preventDefault();
            const email = loginForm['login-email'].value;
            const password = loginForm['login-password'].value;
            const loginError = document.getElementById('login-error');

            try {
                await signInWithEmailAndPassword(auth, email, password);
                showAlert('Giriş başarılı!', 'success');
                loginError.classList.add('hidden');
                showPage('dashboard');
            } catch (error) {
                loginError.textContent = 'Giriş başarısız: ' + error.message;
                loginError.classList.remove('hidden');
                showAlert('Giriş başarısız!', 'error');
            }
        }

        // Register Handler
        async function handleRegister(e) {
            e.preventDefault();
            const name = registerForm['register-name'].value;
            const email = registerForm['register-email'].value;
            const password = registerForm['register-password'].value;
            const registerError = document.getElementById('register-error');

            try {
                const userCredential = await createUserWithEmailAndPassword(auth, email, password);
                await userCredential.user.updateProfile({ displayName: name });
                showAlert('Kayıt başarılı! Giriş yapılıyor...', 'success');
                registerError.classList.add('hidden');
                showPage('dashboard');
            } catch (error) {
                registerError.textContent = 'Kayıt başarısız: ' + error.message;
                registerError.classList.remove('hidden');
                showAlert('Kayıt başarısız!', 'error');
            }
        }

        // List Management (Create, View, Edit, Delete)

        // Add Item to Current List (for Create List Page)
        async function addItemToList() {
            console.log("addItemToList called.");
            const itemNameInput = document.getElementById('item-name');
            const itemQuantityInput = document.getElementById('item-quantity');
            const itemImageInput = document.getElementById('item-image');

            const name = itemNameInput.value.trim();
            const quantity = itemQuantityInput.value.trim();
            const imageFile = itemImageInput.files[0];

            console.log("Item Name:", name);
            console.log("Item Quantity:", quantity);
            console.log("Image File:", imageFile);

            if (!name) {
                showAlert('Lütfen öğe adını girin.', 'error');
                console.log("Item name is empty, returning.");
                return;
            }

            let imageUrl = null;
            if (imageFile) {
                console.log("Image file detected, attempting upload to Imgur...");
                try {
                    imageUrl = await uploadImageToImgur(imageFile, 'imageError');
                    console.log("Imgur upload successful, URL:", imageUrl);
                } catch (error) {
                    console.error("Imgur upload failed:", error);
                    return; 
                }
            }

            currentListItems.push({ name, quantity, imageUrl, checked: false });
            console.log("currentListItems after push:", currentListItems);
            localStorage.setItem('draftItems', JSON.stringify(currentListItems));
            console.log("Draft items saved to localStorage.");
            renderCurrentListItems();
            console.log("renderCurrentListItems called.");

            itemNameInput.value = '';
            itemQuantityInput.value = '';
            itemImageInput.value = '';
            document.getElementById('imageError').textContent = '';
            showAlert('Öğe listeye eklendi.', 'success');
            console.log("Item added successfully alert shown.");
        }
        // addItemToList fonksiyonunu global erişilebilir yap
        window.addItemToList = addItemToList;

        // Render Current List Items (for Create List Page)
        function renderCurrentListItems() {
            console.log("renderCurrentListItems called. Items to render:", currentListItems);
            const itemListDiv = document.getElementById('item-list');
            const emptyListMessage = document.getElementById('empty-list-message');

            itemListDiv.innerHTML = '';

            if (currentListItems.length === 0) {
                emptyListMessage.classList.remove('hidden');
                console.log("currentListItems is empty, showing empty message.");
            } else {
                emptyListMessage.classList.add('hidden');
            }

            currentListItems.forEach((item, index) => {
                console.log(`Rendering item ${index}:`, item);
                const itemDiv = document.createElement('div');
                itemDiv.className = 'flex items-center justify-between bg-gray-50 p-3 rounded-lg mb-2';
                itemDiv.innerHTML = `
                    <div class="flex items-center flex-1">
                        ${item.imageUrl ? `<img src="${item.imageUrl}" class="w-12 h-12 object-cover rounded-md mr-4" alt="Öğe Resmi">` : '<i class="fas fa-box text-2xl text-gray-400 mr-4"></i>'}
                        <div>
                            <p class="font-medium text-gray-800">${item.name}</p>
                            <p class="text-sm text-gray-600">${item.quantity || 'Miktar belirtilmemiş'}</p>
                        </div>
                    </div>
                    <button class="text-red-500 hover:text-red-700 ml-4" onclick="removeItemFromList(${index}, 'current')">
                        <i class="fas fa-trash"></i>
                    </button>
                `;
                itemListDiv.appendChild(itemDiv);
            });
            console.log("Finished rendering items.");
        }

        // Remove Item from List
        function removeItemFromList(index, listType) {
            if (listType === 'current') {
                currentListItems.splice(index, 1);
                localStorage.setItem('draftItems', JSON.stringify(currentListItems));
                renderCurrentListItems();
            } else if (listType === 'edit') {
                editingListItems.splice(index, 1);
                renderEditListItems();
            } else if (listType === 'publicEdit') {
                publicListItems.splice(index, 1);
                renderPublicEditListItems();
            }
            showAlert('Öğe listeden kaldırıldı.', 'success');
        }
        // removeItemFromList fonksiyonunu global erişilebilir yap
        window.removeItemFromList = removeItemFromList;

        // Save List (Create List Page)
        async function saveList() {
            if (!currentUser) {
                showAlert('Lütfen önce giriş yapın', 'error');
                showPage('login');
                return;
            }
            
            const listName = document.getElementById('list-name').value.trim();
            
            if (!listName) {
                showAlert('Lütfen liste adını girin', 'error');
                return;
            }
            
            if (currentListItems.length === 0) {
                showAlert('Lütfen listeye en az bir öğe ekleyin', 'error');
                return;
            }
            
            try {
                const userListsRef = collection(db, `artifacts/${appId}/users/${userId}/lists`);
                const snapshot = await getDocs(userListsRef);
                
                if (snapshot.size >= 4) {
                    showAlert('Maksimum liste sayısına ulaştınız (4/4)', 'error');
                    return;
                }
                
                const docRef = await addDoc(userListsRef, {
                    userId: userId,
                    name: listName,
                    items: currentListItems,
                    createdAt: serverTimestamp(),
                    updatedAt: serverTimestamp()
                });
                
                currentListId = docRef.id;
                localStorage.removeItem('draftItems');
                showAlert('Liste başarıyla kaydedildi!', 'success');
                showPage('viewList');
                displayListDetails(currentListId);
            } catch (error) {
                showAlert('Liste kaydedilirken bir hata oluştu: ' + error.message, 'error');
                console.error("Error saving list: ", error);
            }
        }
        // saveList fonksiyonunu global erişilebilir yap
        window.saveList = saveList;

        // Load User Lists (Dashboard Page)
        async function loadUserLists() {
            if (!currentUser) {
                return;
            }

            const userListsDiv = document.getElementById('user-lists');
            userListsDiv.innerHTML = '';
            document.getElementById('no-lists-message').classList.add('hidden');
            document.getElementById('qr-list-counter').textContent = '';

            try {
                const listsRef = collection(db, `artifacts/${appId}/users/${userId}/lists`);
                const q = query(listsRef);
                const snapshot = await getDocs(q);

                if (snapshot.empty) {
                    document.getElementById('no-lists-message').classList.remove('hidden');
                    return;
                }

                document.getElementById('qr-list-counter').textContent = `Toplam ${snapshot.size}/4 liste`;

                const sortedLists = [];
                snapshot.forEach(doc => {
                    sortedLists.push({ id: doc.id, ...doc.data() });
                });
                sortedLists.sort((a, b) => (b.createdAt?.toMillis() || 0) - (a.createdAt?.toMillis() || 0));

                sortedLists.forEach(listData => {
                    const listId = listData.id;
                    const list = listData;

                    const listCard = document.createElement('div');
                    listCard.className = 'bg-white p-6 rounded-xl shadow-md flex flex-col justify-between';
                    listCard.innerHTML = `
                        <div>
                            <h3 class="text-xl font-bold text-gray-800 mb-2">${list.name}</h3>
                            <p class="text-sm text-gray-600 mb-4">${list.items ? list.items.length : 0} öğe</p>
                        </div>
                        <div class="flex space-x-2 mt-4">
                            <button onclick="displayListDetails('${listId}')" class="flex-1 bg-primary text-white px-4 py-2 rounded-lg hover-bg-primary transition-all text-sm">
                                <i class="fas fa-eye mr-2"></i> Görüntüle
                            </button>
                            <button onclick="confirmDeleteList('${listId}')" class="flex-1 bg-red-500 text-white px-4 py-2 rounded-lg hover:bg-red-600 transition-all text-sm">
                                <i class="fas fa-trash mr-2"></i> Sil
                            </button>
                        </div>
                    `;
                    userListsDiv.appendChild(listCard);
                });
            } catch (error) {
                showAlert('Listeler yüklenirken bir hata oluştu: ' + error.message, 'error');
                console.error("Error loading user lists: ", error);
            }
        }

        // Display List Details (View List Page)
        async function displayListDetails(listId) {
            currentListId = listId;
            showPage('viewList');
            const viewListName = document.getElementById('view-list-name');
            const viewItemList = document.getElementById('view-item-list');
            const qrcodeContainer = document.getElementById('qrcode-container');
            const sharePubliclyButton = document.getElementById('share-publicly-button'); // Butonu tekrar alıyoruz

            viewListName.textContent = 'Liste Yükleniyor...';
            viewItemList.innerHTML = '';
            
            if (qrcodeContainer) {
                qrcodeContainer.innerHTML = '';
            } else {
                console.error("QR Kod Konteyneri (qrcode-container) bulunamadı!");
                showAlert('QR kod alanı bulunamadı.', 'error');
                return;
            }

            try {
                const listDocRef = doc(db, `artifacts/${appId}/users/${userId}/lists`, listId);
                const listDoc = await getDoc(listDocRef);
                if (!listDoc.exists()) {
                    showAlert('Liste bulunamadı.', 'error');
                    showPage('dashboard');
                    return;
                }

                const list = listDoc.data();
                viewListName.textContent = list.name;
                currentListItems = list.items || [];

                if (currentListItems.length === 0) {
                    viewItemList.innerHTML = '<p class="text-center py-8 text-gray-500"><i class="fas fa-clipboard text-4xl mb-3"></i><p>Bu listede hiç öğe yok.</p></p>';
                } else {
                    currentListItems.forEach(item => {
                        const itemDiv = document.createElement('div');
                        itemDiv.className = 'flex items-center bg-gray-50 p-3 rounded-lg mb-2';
                        itemDiv.innerHTML = `
                            <input type="checkbox" ${item.checked ? 'checked' : ''} class="form-checkbox h-5 w-5 text-primary mr-4" onchange="toggleItemChecked('${listId}', '${item.name}', event.target.checked)">
                            ${item.imageUrl ? `<img src="${item.imageUrl}" class="w-12 h-12 object-cover rounded-md mr-4" alt="Öğe Resmi">` : '<i class="fas fa-box text-2xl text-gray-400 mr-4"></i>'}
                            <div class="flex-1">
                                <p class="font-medium text-gray-800 ${item.checked ? 'line-through text-gray-500' : ''}">${item.name}</p>
                                <p class="text-sm text-gray-600">${item.quantity || 'Miktar belirtilmemiş'}</p>
                            </div>
                        `;
                        viewItemList.appendChild(itemDiv);
                    });
                }

                // Check if the list is already public
                const publicListDocRef = doc(db, `artifacts/${appId}/public/data/lists`, listId);
                const publicListDoc = await getDoc(publicListDocRef);

                if (publicListDoc.exists() && publicListDoc.data().userId === userId) {
                    sharePubliclyButton.textContent = "Genel Paylaşıldı";
                    sharePubliclyButton.classList.remove('bg-green-500', 'hover:bg-green-600');
                    sharePubliclyButton.classList.add('bg-gray-400', 'cursor-not-allowed');
                    sharePubliclyButton.disabled = true;
                } else {
                    sharePubliclyButton.textContent = "Genel Paylaş";
                    sharePubliclyButton.classList.remove('bg-gray-400', 'cursor-not-allowed');
                    sharePubliclyButton.classList.add('bg-green-500', 'hover:bg-green-600');
                    sharePubliclyButton.disabled = false;
                }


                const qrCodeUrl = `${window.location.origin}?list=${listId}`;
                console.log("QR Kod için URL oluşturuluyor:", qrCodeUrl);
                try {
                    new QRCode(qrcodeContainer, {
                        text: qrCodeUrl,
                        width: 200,
                        height: 200,
                        colorDark: "#4f46e5",
                        colorLight: "#ffffff",
                        correctLevel: QRCode.CorrectLevel.H
                    });
                    console.log("QR Kod başarıyla oluşturuldu.");
                } catch (qrError) {
                    console.error("QRCode.js ile QR Kod oluşturulurken hata oluştu:", qrError);
                    showAlert('QR kod oluşturulurken bir hata oluştu.', 'error');
                }

            } catch (error) {
                showAlert('Liste detayları yüklenirken bir hata oluştu: ' + error.message, 'error');
                console.error("Error displaying list details: ", error);
                showPage('dashboard');
            }
        }
        // displayListDetails fonksiyonunu global erişilebilir yap
        window.displayListDetails = displayListDetails;

        // Share List Publicly Function
        async function shareListPublicly(listId) {
            if (!currentUser) {
                showAlert('Lütfen önce giriş yapın.', 'error');
                showPage('login');
                return;
            }
            if (!listId) {
                showAlert('Paylaşılacak bir liste seçilmedi.', 'error');
                return;
            }

            try {
                // Fetch the private list data
                const privateListDocRef = doc(db, `artifacts/${appId}/users/${userId}/lists`, listId);
                const privateListDoc = await getDoc(privateListDocRef);

                if (!privateListDoc.exists()) {
                    showAlert('Paylaşılacak liste bulunamadı.', 'error');
                    return;
                }

                const listData = privateListDoc.data();
                
                // Prepare data for public collection
                const publicListData = {
                    ...listData, // Copy all fields from private list
                    userId: userId, // Ensure userId is explicitly set for security rules
                    sharedAt: serverTimestamp(), // Add a timestamp for when it was shared
                    // createdAt and updatedAt from private list are also copied
                };

                // Save a copy to the public collection with the same ID
                const publicListDocRef = doc(db, `artifacts/${appId}/public/data/lists`, listId);
                await setDoc(publicListDocRef, publicListData); // setDoc ile aynı ID'yi kullanarak kaydediyoruz

                showAlert('Liste başarıyla genel olarak paylaşıldı!', 'success');
                displayListDetails(listId); // Refresh the view to show "Genel Paylaşıldı"
            } catch (error) {
                showAlert('Liste genel olarak paylaşılırken bir hata oluştu: ' + error.message, 'error');
                console.error("Error sharing list publicly: ", error);
            }
        }
        // shareListPublicly fonksiyonunu global erişilebilir yap
        window.shareListPublicly = shareListPublicly;


        // Toggle Item Checked Status
        async function toggleItemChecked(listId, itemName, isChecked) {
            try {
                const listDocRef = doc(db, `artifacts/${appId}/users/${userId}/lists`, listId);
                const listDoc = await getDoc(listDocRef);
                if (!listDoc.exists()) return;

                const listData = listDoc.data();
                const updatedItems = listData.items.map(item =>
                    item.name === itemName ? { ...item, checked: isChecked } : item
                );

                await updateDoc(listDocRef, { items: updatedItems });
                showAlert('Liste öğesi güncellendi.', 'success');
                displayListDetails(listId);
            } catch (error) {
                showAlert('Öğe durumu güncellenirken bir hata oluştu: ' + error.message, 'error');
                console.error("Error updating item checked status: ", error);
            }
        }
        // toggleItemChecked fonksiyonunu global erişilebilir yap
        window.toggleItemChecked = toggleItemChecked;

        // Edit List (from View List Page)
        async function editList() {
            if (!currentListId) {
                showAlert('Düzenlenecek bir liste seçilmedi.', 'error');
                return;
            }

            showPage('editList');
            const editListNameInput = document.getElementById('edit-list-name');
            const editListIdPara = document.getElementById('edit-list-id');

            editListIdPara.textContent = `Liste ID: ${currentListId}`;

            try {
                const listDocRef = doc(db, `artifacts/${appId}/users/${userId}/lists`, currentListId);
                const listDoc = await getDoc(listDocRef);
                if (!listDoc.exists()) {
                    showAlert('Düzenlenecek liste bulunamadı.', 'error');
                    showPage('dashboard');
                    return;
                }

                const list = listDoc.data();
                editListNameInput.value = list.name;
                editingListItems = list.items || [];
                renderEditListItems();
                editingListId = currentListId;
            } catch (error) {
                showAlert('Liste düzenleme formu yüklenirken bir hata oluştu: ' + error.message, 'error');
                console.error("Error loading list edit form: ", error);
                showPage('viewList');
            }
        }
        // editList fonksiyonunu global erişilebilir yap
        window.editList = editList;

        // Add Item to Edit List
        async function addItemToEditList() {
            const itemNameInput = document.getElementById('edit-item-name');
            const itemQuantityInput = document.getElementById('edit-item-quantity');
            const itemImageInput = document.getElementById('edit-item-image');

            const name = itemNameInput.value.trim();
            const quantity = itemQuantityInput.value.trim();
            const imageFile = itemImageInput.files[0];

            if (!name) {
                showAlert('Lütfen öğe adını girin.', 'error');
                return;
            }

            let imageUrl = null;
            if (imageFile) {
                try {
                    imageUrl = await uploadImageToImgur(imageFile, 'editImageError');
                } catch (error) {
                    return; 
                }
            }

            editingListItems.push({ name, quantity, imageUrl, checked: false });
            renderEditListItems();

            itemNameInput.value = '';
            itemQuantityInput.value = '';
            itemImageInput.value = '';
            document.getElementById('editImageError').textContent = '';
            showAlert('Öğe düzenleme listesine eklendi.', 'success');
        }
        // addItemToEditList fonksiyonunu global erişilebilir yap
        window.addItemToEditList = addItemToEditList;

        // Render Edit List Items
        function renderEditListItems() {
            const editItemListDiv = document.getElementById('edit-item-list');
            editItemListDiv.innerHTML = '';

            if (editingListItems.length === 0) {
                editItemListDiv.innerHTML = '<p class="text-center py-8 text-gray-500"><i class="fas fa-clipboard text-4xl mb-3"></i><p>Henüz öğe eklemediniz.</p></p>';
                return;
            }

            editingListItems.forEach((item, index) => {
                const itemDiv = document.createElement('div');
                itemDiv.className = 'flex items-center justify-between bg-gray-50 p-3 rounded-lg mb-2';
                itemDiv.innerHTML = `
                    <div class="flex items-center flex-1">
                        ${item.imageUrl ? `<img src="${item.imageUrl}" class="w-12 h-12 object-cover rounded-md mr-4" alt="Öğe Resmi">` : '<i class="fas fa-box text-2xl text-gray-400 mr-4"></i>'}
                        <div>
                            <p class="font-medium text-gray-800">${item.name}</p>
                            <p class="text-sm text-gray-600">${item.quantity || 'Miktar belirtilmemiş'}</p>
                        </div>
                    </div>
                    <button class="text-red-500 hover:text-red-700 ml-4" onclick="removeItemFromList(${index}, 'edit')">
                        <i class="fas fa-trash"></i>
                    </button>
                `;
                editItemListDiv.appendChild(itemDiv);
            });
        }

        // Update List
        async function updateList() {
            if (!editingListId) {
                showAlert('Güncellenecek bir liste seçilmedi.', 'error');
                return;
            }

            const listName = document.getElementById('edit-list-name').value.trim();

            if (!listName) {
                showAlert('Lütfen liste adını girin.', 'error');
                return;
            }

            if (editingListItems.length === 0) {
                showAlert('Lütfen listeye en az bir öğe ekleyin', 'error');
                return;
            }

            try {
                const listDocRef = doc(db, `artifacts/${appId}/users/${userId}/lists`, editingListId);
                await updateDoc(listDocRef, {
                    name: listName,
                    items: editingListItems,
                    updatedAt: serverTimestamp()
                });

                showAlert('Liste başarıyla güncellendi!', 'success');
                showPage('viewList');
                displayListDetails(editingListId);
                editingListId = null;
                editingListItems = [];
            } catch (error) {
                showAlert('Liste güncellenirken bir hata oluştu: ' + error.message, 'error');
                console.error("Error updating list: ", error);
            }
        }
        // updateList fonksiyonunu global erişilebilir yap
        window.updateList = updateList;

        // Delete List
        async function deleteList(listId) {
            try {
                // Delete associated images in storage (optional but good practice)
                const listDocRef = doc(db, `artifacts/${appId}/users/${userId}/lists`, listId);
                const listDoc = await getDoc(listDocRef);
                if (listDoc.exists()) {
                    const listData = listDoc.data();
                    if (listData.items) {
                        for (const item of listData.items) {
                            if (item.imageUrl && item.imageUrl.includes('imgur.com')) {
                                console.log(`Imgur image: ${item.imageUrl} - not deleting from Firebase Storage.`);
                            } else if (item.imageUrl) {
                                try {
                                    const imageRef = ref(storage, item.imageUrl);
                                    await deleteObject(imageRef);
                                    console.log(`Firebase Storage image deleted: ${item.imageUrl}`);
                                } catch (imageError) {
                                    console.warn("Image could not be deleted (might not exist or permission issue):", imageError);
                                }
                            }
                        }
                    }
                }

                await deleteDoc(listDocRef); // Delete the private list
                
                // Also delete the public version if it exists
                const publicListDocRef = doc(db, `artifacts/${appId}/public/data/lists`, listId);
                await deleteDoc(publicListDocRef).catch(e => console.warn("Public list not found or could not be deleted:", e));

                showAlert('Liste başarıyla silindi.', 'success');
                loadUserLists();
            } catch (error) {
                showAlert('Liste silinirken bir hata oluştu: ' + error.message, 'error');
                console.error("Error deleting list: ", error);
            }
        }

        // QR Code Functions

        // Download QR Code
        function downloadQrCode() {
            let containerId = 'qrcode-container';
            if (qrModal.classList.contains('flex')) {
                containerId = 'modal-qrcode-container';
            }

            const qrcodeSvg = document.getElementById(containerId).querySelector('svg');
            if (qrcodeSvg) {
                const serializer = new XMLSerializer();
                const svgString = serializer.serializeToString(qrcodeSvg);

                const canvas = document.createElement('canvas');
                const ctx = canvas.getContext('2d');
                const img = new Image();

                img.onload = () => {
                    canvas.width = img.width;
                    canvas.height = img.height;
                    ctx.drawImage(img, 0, 0);

                    const a = document.createElement('a');
                    a.download = `QRListe_${currentListId || 'list'}.png`;
                    a.href = canvas.toDataURL('image/png');
                    a.click();
                    showAlert('QR Kod indirildi!', 'success');
                };

                img.src = 'data:image/svg+xml;base64,' + btoa(svgString);
            } else {
                showAlert('QR kod indirilemiyor. Lütfen ekran görüntüsü almayı deneyin.', 'error');
            }
        }
        // downloadQrCode fonksiyonunu global erişilebilir yap
        window.downloadQrCode = downloadQrCode;

        // Open QR Modal (not directly used currently but a good function)
        function openQrModal(listId, qrCodeUrl) {
            document.getElementById('modal-qrcode-container').innerHTML = '';
            new QRCode(document.getElementById('modal-qrcode-container'), {
                text: qrCodeUrl,
                width: 200,
                height: 200,
                colorDark: "#4f46e5",
                colorLight: "#ffffff",
                correctLevel: QRCode.CorrectLevel.H
            });
            document.getElementById('qr-list-id').textContent = listId;
            qrModal.classList.remove('hidden');
            qrModal.classList.add('flex');
        }

        // Close QR Modal
        function closeQrModal() {
            qrModal.classList.add('hidden');
            qrModal.classList.remove('flex');
            document.getElementById('modal-qrcode-container').innerHTML = '';
        }
        // closeQrModal fonksiyonunu global erişilebilir yap
        window.closeQrModal = closeQrModal;

        // Copy List ID
        function copyListId() {
            const listIdText = document.getElementById('qr-list-id').textContent;
            const tempInput = document.createElement('textarea');
            tempInput.value = listIdText;
            document.body.appendChild(tempInput);
            tempInput.select();
            document.execCommand('copy');
            document.body.removeChild(tempInput);
            showAlert('Liste ID kopyalandı!', 'success');
        }
        // copyListId fonksiyonunu global erişilebilir yap
        window.copyListId = copyListId;

        // Public List Viewing and Editing

        // Load Public List from URL
        async function loadPublicList(listId) {
            publicListId = listId;
            showPage('publicList');
            const publicListName = document.getElementById('public-list-name');
            const publicListIdPara = document.getElementById('public-list-id');
            const publicItemList = document.getElementById('public-item-list');

            publicListName.textContent = 'Liste Yükleniyor...';
            publicListIdPara.textContent = `Liste ID: ${listId}`;
            publicItemList.innerHTML = '';

            try {
                const listDocRef = doc(db, `artifacts/${appId}/public/data/lists`, listId);
                const listDoc = await getDoc(listDocRef);
                if (!listDoc.exists()) {
                    showAlert('Paylaşılan liste bulunamadı.', 'error');
                    showPage('home');
                    return;
                }

                const list = listDoc.data();
                publicListName.textContent = list.name;
                publicListItems = list.items || [];

                if (publicListItems.length === 0) {
                    publicItemList.innerHTML = '<p class="text-center py-8 text-gray-500"><i class="fas fa-clipboard text-4xl mb-3"></i><p>Bu listede hiç öğe yok.</p></p>';
                } else {
                    publicListItems.forEach(item => {
                        const itemDiv = document.createElement('div');
                        itemDiv.className = 'flex items-center bg-gray-50 p-3 rounded-lg mb-2';
                        itemDiv.innerHTML = `
                            <input type="checkbox" ${item.checked ? 'checked' : ''} class="form-checkbox h-5 w-5 text-primary mr-4" onchange="togglePublicItemChecked('${listId}', '${item.name}', event.target.checked)">
                            ${item.imageUrl ? `<img src="${item.imageUrl}" class="w-12 h-12 object-cover rounded-md mr-4" alt="Öğe Resmi">` : '<i class="fas fa-box text-2xl text-gray-400 mr-4"></i>'}
                            <div class="flex-1">
                                <p class="font-medium text-gray-800 ${item.checked ? 'line-through text-gray-500' : ''}">${item.name}</p>
                                <p class="text-sm text-gray-600">${item.quantity || 'Miktar belirtilmemiş'}</p>
                            </div>
                        `;
                        publicItemList.appendChild(itemDiv);
                    });
                }
            } catch (error) {
                showAlert('Paylaşılan liste yüklenirken bir hata oluştu: ' + error.message, 'error');
                console.error("Error loading public list: ", error);
                showPage('home');
            }
        }
        // loadPublicList fonksiyonunu global erişilebilir yap
        window.loadPublicList = loadPublicList;

        // Toggle Public Item Checked Status
        async function togglePublicItemChecked(listId, itemName, isChecked) {
            try {
                const listDocRef = doc(db, `artifacts/${appId}/public/data/lists`, listId);
                const listDoc = await getDoc(listDocRef);
                if (!listDoc.exists()) return;

                const listData = listDoc.data();
                const updatedItems = listData.items.map(item =>
                    item.name === itemName ? { ...item, checked: isChecked } : item
                );

                await updateDoc(listDocRef, { items: updatedItems });
                showAlert('Liste öğesi güncellendi.', 'success');
                loadPublicList(listId);
            } catch (error) {
                showAlert('Öğe durumu güncellenirken bir hata oluştu: ' + error.message, 'error');
                console.error("Error updating public item checked status: ", error);
            }
        }
        // togglePublicItemChecked fonksiyonunu global erişilebilir yap
        window.togglePublicItemChecked = togglePublicItemChecked;

        // Edit Public List
        async function editPublicList() {
            if (!publicListId) {
                showAlert('Düzenlenecek bir genel liste seçilmedi.', 'error');
                return;
            }

            try {
                const listDocRef = doc(db, `artifacts/${appId}/public/data/lists`, publicListId);
                const listDoc = await getDoc(listDocRef);
                // Check if the list exists and the current user is the owner
                if (!listDoc.exists() || listDoc.data().userId !== userId) {
                    showAlert('Bu listeyi düzenleme yetkiniz yok.', 'error');
                    return;
                }
            } catch (error) {
                showAlert('Liste yetkisi kontrol edilirken hata oluştu: ' + error.message, 'error');
                console.error("Error checking public list permission: ", error);
                return;
            }


            showPage('editPublicList');
            const editPublicListNameInput = document.getElementById('edit-public-list-name');
            const editPublicListIdPara = document.getElementById('edit-public-list-id');

            editPublicListIdPara.textContent = `Liste ID: ${publicListId}`;

            try {
                const listDocRef = doc(db, `artifacts/${appId}/public/data/lists`, publicListId);
                const listDoc = await getDoc(listDocRef);
                if (!listDoc.exists()) {
                    showAlert('Düzenlenecek genel liste bulunamadı.', 'error');
                    showPage('publicList');
                    return;
                }

                const list = listDoc.data();
                editPublicListNameInput.value = list.name;
                publicListItems = list.items || [];
                renderPublicEditListItems();
            } catch (error) {
                showAlert('Genel liste düzenleme formu yüklenirken bir hata oluştu: ' + error.message, 'error');
                console.error("Error loading public list edit form: ", error);
                showPage('publicList');
            }
        }
        // editPublicList fonksiyonunu global erişilebilir yap
        window.editPublicList = editPublicList;

        // Add Item to Public Edit List
        async function addItemToPublicList() {
            const itemNameInput = document.getElementById('edit-public-item-name');
            const itemQuantityInput = document.getElementById('edit-public-item-quantity');
            const itemImageInput = document.getElementById('edit-public-item-image');

            const name = itemNameInput.value.trim();
            const quantity = itemQuantityInput.value.trim();
            const imageFile = itemImageInput.files[0];

            if (!name) {
                showAlert('Lütfen öğe adını girin.', 'error');
                return;
            }

            let imageUrl = null;
            if (imageFile) {
                try {
                    imageUrl = await uploadImageToImgur(imageFile, 'editPublicImageError');
                } catch (error) {
                    return;
                }
            }

            publicListItems.push({ name, quantity, imageUrl, checked: false });
            renderPublicEditListItems();

            itemNameInput.value = '';
            itemQuantityInput.value = '';
            itemImageInput.value = '';
            document.getElementById('editPublicImageError').textContent = '';
            showAlert('Öğe genel listeye eklendi.', 'success');
        }
        // addItemToPublicList fonksiyonunu global erişilebilir yap
        window.addItemToPublicList = addItemToPublicList;

        // Render Public Edit List Items
        function renderPublicEditListItems() {
            const editPublicItemListDiv = document.getElementById('edit-public-item-list');
            editPublicItemListDiv.innerHTML = '';

            if (publicListItems.length === 0) {
                editPublicItemListDiv.innerHTML = '<p class="text-center py-8 text-gray-500"><i class="fas fa-clipboard text-4xl mb-3"></i><p>Henüz öğe eklemediniz.</p></p>';
                return;
            }

            publicListItems.forEach((item, index) => {
                const itemDiv = document.createElement('div');
                itemDiv.className = 'flex items-center justify-between bg-gray-50 p-3 rounded-lg mb-2';
                itemDiv.innerHTML = `
                    <div class="flex items-center flex-1">
                        ${item.imageUrl ? `<img src="${item.imageUrl}" class="w-12 h-12 object-cover rounded-md mr-4" alt="Öğe Resmi">` : '<i class="fas fa-box text-2xl text-gray-400 mr-4"></i>'}
                        <div>
                            <p class="font-medium text-gray-800">${item.name}</p>
                            <p class="text-sm text-gray-600">${item.quantity || 'Miktar belirtilmemiş'}</p>
                        </div>
                    </div>
                    <button class="text-red-500 hover:text-red-700 ml-4" onclick="removeItemFromList(${index}, 'publicEdit')">
                        <i class="fas fa-trash"></i>
                    </button>
                `;
                editPublicItemListDiv.appendChild(itemDiv);
            });
        }

        // Update Public List
        async function updatePublicList() {
            if (!publicListId) {
                showAlert('Güncellenecek bir genel liste seçilmedi.', 'error');
                return;
            }

            const listName = document.getElementById('edit-public-list-name').value.trim();

            if (!listName) {
                showAlert('Lütfen liste adını girin.', 'error');
                return;
            }

            if (publicListItems.length === 0) {
                showAlert('Lütfen listeye en az bir öğe ekleyin', 'error');
                return;
            }

            try {
                const listDocRef = doc(db, `artifacts/${appId}/public/data/lists`, publicListId);
                await updateDoc(listDocRef, {
                    name: listName,
                    items: publicListItems,
                    updatedAt: serverTimestamp()
                });

                showAlert('Liste başarıyla güncellendi!', 'success');
                showPage('publicList');
                loadPublicList(publicListId);
            } catch (error) {
                showAlert('Genel liste güncellenirken bir hata oluştu: ' + error.message, 'error');
                console.error("Error updating public list: ", error);
            }
        }
        // updatePublicList fonksiyonunu global erişilebilir yap
        window.updatePublicList = updatePublicList;

        // İletişim Formu İşleyici
        async function handleContactForm(e) {
            e.preventDefault();
            const name = document.getElementById('contact-name').value;
            const email = document.getElementById('contact-email').value;
            const subject = document.getElementById('contact-subject').value;
            const message = document.getElementById('contact-message').value;

            try {
                console.log('İletişim Formu Verileri:', { name, email, subject, message });

                showAlert('Mesajınız başarıyla gönderildi!', 'success');
                contactForm.reset();
            } catch (error) {
                showAlert('Mesaj gönderilirken bir hata oluştu: ' + error.message, 'error');
                console.error("İletişim formu hatası: ", error);
            }
        }
        // handleContactForm fonksiyonunu global erişilebilir yap
        window.handleContactForm = handleContactForm;

        // Initialize the app when the DOM is fully loaded
        document.addEventListener('DOMContentLoaded', initApp);
    </script>
</body>
</html>
